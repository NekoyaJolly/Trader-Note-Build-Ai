name: Security & Quality Checks

on:
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥åˆå‰ 2 æ™‚ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'

jobs:
  # ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
  security-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: npm audit ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: npm audit ãƒ¬ãƒãƒ¼ãƒˆ
        if: failure()
        run: |
          echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo "è©³ç´°ã¯ npm audit ã®å‡ºåŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: TypeScript è¤‡é›‘åº¦ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ“Š TypeScript ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ:"
          find src -name "*.ts" ! -name "*.test.ts" ! -path "*/node_modules/*" | wc -l | xargs echo "  ãƒ•ã‚¡ã‚¤ãƒ«æ•°:"
          find src -name "*.ts" ! -name "*.test.ts" ! -path "*/node_modules/*" -exec wc -l {} + | tail -1 | awk '{print "  ç·è¡Œæ•°: " $1}'

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
        run: npm test -- --coverage --passWithNoTests 2>&1 | grep -E "(PASS|FAIL|%)"
        continue-on-error: true

  # ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
  env-validation:
    name: Environment Variables Validation
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å­˜åœ¨ç¢ºèª
        run: |
          if [ -f .env.example ] || [ -f .env.template ]; then
            echo "âœ… ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå­˜åœ¨ã—ã¾ã™"
          else
            echo "âš ï¸ ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ.env.example ã¾ãŸã¯ .env.templateï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "æ¨å¥¨: .env.example ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„"
          fi
        continue-on-error: true

  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¢ºèª
  documentation:
    name: Documentation Verification
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: README.md å­˜åœ¨ç¢ºèª
        run: |
          if [ -f README.md ]; then
            echo "âœ… README.md ãŒå­˜åœ¨ã—ã¾ã™"
            echo ""
            echo "ğŸ“„ README ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç¢ºèª:"
            grep -E "^#{1,3} " README.md | head -10 || echo "ã‚»ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ãªã—"
          else
            echo "âŒ README.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¢ºèª
        run: |
          if [ -f docs/API.md ]; then
            echo "âœ… API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™"
          else
            echo "âš ï¸ docs/API.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
        continue-on-error: true

  # Git ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
  commit-lint:
    name: Commit Message Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª
        run: |
          echo "ğŸ“ æœ€æ–°ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:"
          git log -1 --pretty=%B
          echo ""
          echo "âœ… ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ãƒã‚§ãƒƒã‚¯å®Œäº†"
        continue-on-error: true

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å“è³ªãƒã‚§ãƒƒã‚¯ã‚µãƒãƒªãƒ¼
  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [security-audit, code-quality, env-validation, documentation]
    if: always()
    steps:
      - name: ãƒã‚§ãƒƒã‚¯çµæœã‚µãƒãƒªãƒ¼
        run: |
          echo "================================"
          echo "ğŸ“‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å“è³ªãƒã‚§ãƒƒã‚¯çµæœ"
          echo "================================"
          echo ""
          echo "å®Ÿè¡Œé …ç›®:"
          echo "  ğŸ” ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»"
          echo "  ğŸ“Š ã‚³ãƒ¼ãƒ‰å“è³ªåˆ†æ"
          echo "  ğŸ”§ ç’°å¢ƒå¤‰æ•°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³"
          echo "  ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¢ºèª"
          echo "  âœï¸  ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª"
          echo ""
          echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
          if [ "${{ job.status }}" == "success" ]; then
            echo "  âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "  âš ï¸  ã„ãã¤ã‹ã®ãƒã‚§ãƒƒã‚¯ã§æ³¨æ„ãŒå¿…è¦ã§ã™"
          fi
