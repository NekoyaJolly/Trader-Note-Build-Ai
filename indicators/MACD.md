# MACD 定義書（Moving Average Convergence Divergence）

本定義は TradeAssist における MACD の公式ドキュメントであり、雛形と同一構造で記述する。MACD はモメンタムとトレンド変化の兆しを補助的に捉える役割を担い、SMA を主軸、RSI を過熱判定軸とする設計に整合させる。クロスを絶対シグナルとして扱わず、単独での売買判断を禁止する。

## メタ情報（管理用）
- indicator_id: `macd`
- カテゴリ: momentum / trend-change（モメンタム・トレンド変化補助）
- 定義バージョン: 1.0.0
- 導入日: 2025-12-27

## 1. インジケーター概要
- 短期 EMA と長期 EMA の収束・発散を用いて、トレンドの加速・減速や反転初動の兆しを示すモメンタム系インジケーター
- 標準期間: 短期 12、長期 26、シグナル 9（いずれも終値ベース EMA）。期間変更はユーザー設定として許可するが、SMA を主軸とする前提を崩さない

## 2. 想定トレーダーペルソナ
- トレンドフォローを基本としつつ、早期の加速・減速兆候を捕捉したいトレーダー（経験 2〜4 年、リスク許容度: 中）
- 日中に複数回モニタリングし、SMA で方向確認後に MACD で変化の兆しを補足する慎重な運用スタイル

## 3. 対応トレードスタイル（スキャル / デイ）
- スキャル: 1〜5 分足で期間をやや短縮（例: 8/17/5）。ノイズ許容が低く、ヒストグラム増減速度を重視
- デイ: 15〜60 分足で標準期間（12/26/9）。主要セッションでのトレンド方向を SMA で確認し、MACD は変化の兆し判定に限定

## 4. 生データとして記録する項目（Layer1）
- 時系列終値（必須）、時間足（例: 1m/5m/15m/60m）、短期期間 N_fast（初期値 12）、長期期間 N_slow（初期値 26）、シグナル期間 N_signal（初期値 9）
- 価格取得元: 市場データ API（終値精度は少なくとも小数第 2 位まで保持）
- 欠損補填: 終値欠損時はその足を無視し、連続欠損 2 本以上で算出停止とする
- タイムゾーン: UTC で保存し、表示時にユーザータイムゾーンへ変換
- 計算値として記録: MACD ライン（EMA_fast − EMA_slow）、シグナルライン（MACD ラインの EMA）、ヒストグラム（MACD − シグナル）。計算済み値を Layer1 として保持し再利用する

## 5. 判断コンテキスト（Layer2）
- 現在値: MACD ライン、シグナルライン、ヒストグラム
- 乖離量（正規化）: divergence_norm = (MACD − シグナル) / |SMA| × 100（SMA は同時間足の主軸トレンド線）。異なる価格帯でも比較できるよう正規化
- 0 ラインとの位置関係: MACD の符号（上=強気傾向、下=弱気傾向）と経過本数
- 傾き・速度: MACD 傾き（MACD[t] − MACD[t-1]）、シグナル傾き、ヒストグラム増減速度（hist[t] − hist[t-1]）。直近 3 本平均も保持
- クロス情報: MACD とシグナルの交差有無と経過本数（ただし絶対シグナル化は禁止。文脈評価のみ）
- 継続時間: 0 ライン上/下に滞在した本数、ヒストグラムが同符号で続く本数
- SMA/RSI 整合: 同時間足 SMA の傾き方向、RSI の過熱判定（70/30 近辺）の整合・矛盾フラグ

## 6. 言語化レイヤー（Layer3）
- 「勢い増加」= ヒストグラムが正で増加傾向（hist[t] > 0 かつ hist[t] − hist[t-1] > 0）を 2 本以上継続
- 「勢い減速」= ヒストグラムが正でも減少、または負でも増加に転じた状態（|hist[t]| < |hist[t-1]|）が 2 本以上継続
- 「トレンド加速の兆候」= SMA と同方向に MACD が 0 ラインを抜け、ヒストグラムが増加傾向
- 「反転初動の可能性」= ヒストグラムがゼロ付近で符号を跨ぎ、SMA 方向と逆向きに 0 ライン跨ぎが起きた直後（1〜2 本以内）。RSI が逆行（例: SMA 上向きで RSI 売られすぎ）なら見送り理由を付与
- 「横ばい/力不足」= MACD とシグナルの距離が小さく（divergence_norm の絶対値が tol_small 未満）、ヒストグラムも小さい状態が 3 本以上継続
- 注意: クロス単体を「買い/売り」語彙に直結させない。必ず SMA と RSI の整合を確認する

## 7. ユーザー基準値の扱い
- 期間変更: N_fast/N_slow/N_signal を整数で設定可（例: 8/17/5、12/26/9、19/39/9）。N_fast < N_slow をバリデーションで必須
- tol_small（初期値: 0.05% 相当）やヒストグラム増減の感度を設定可。0 < tol_small ≤ 1.0 を許容
- 設定変更時は Layer2 の乖離・傾き計算と Layer3 の語彙判定に即時反映

## 8. マッチングに使用する特徴量
- MACD ライン、シグナルライン、ヒストグラム値とそれぞれの傾き
- divergence_norm、0 ライン位置、同符号継続本数、クロス発生有無と経過本数
- SMA 傾き方向（主軸トレンド）との一致/不一致、RSI 過熱判定との整合/矛盾フラグ
- 例マッチング条件:
  - 「SMA が上向き、MACD が 0 ライン上でヒストグラム増加」→ トレンド加速の根拠
  - 「SMA が上向きだが MACD が 0 ライン下でヒストグラム減少」→ 反転初動警戒。エントリー見送り候補
  - 「RSI が買われすぎで、MACD が勢い減速」→ 伸び切り警戒の注意喚起
- 役割優先順位: 1) SMA = トレンド軸、2) RSI = 過熱軸、3) MACD = 変化兆候軸。矛盾時は SMA/RSI を優先し、MACD は注意喚起に留める

## 9. AI が利用してよい情報 / 禁止情報
- 利用可: Layer2/Layer3 の特徴量（MACD/シグナル/ヒストグラム、乖離、傾き、継続本数、整合フラグ）、ユーザー設定値、時間足、マッチ理由テキスト
- 禁止: 個別ローソク足の生データ（高値・安値等）、出来高、個別銘柄名や未公開注文履歴などの個人情報。AI 入力前に匿名化し、集計済み特徴のみを渡す

## 10. 将来拡張時の注意点
- 期間変更や平滑化手法変更（例: EMA → DEMA）時は、過去ノートとの互換性と閾値の再調整を明示する
- 他インジケーターとの組み合わせ: SMA との方向一致を最優先、RSI と逆行する場合は「見送り推奨」をデフォルトにする
- バージョニング: 期間セットや感度変更ごとにバージョンタグを付与し、マッチ結果差分を記録する

## 11. 本インジケーターが不適切な状況
- **強トレンド継続で乖離が固定化している局面**: SMA が明確に片方向へ傾き続け、MACD が同符号で張り付く場合、反転判定が機能しにくい
- **高インパクト指標発表前後の非連続変動**: ギャップで EMA が急変し、直近のヒストグラム変化が実需を反映しない可能性が高い
- **極端な出来高低下やスプレッド拡大**: ノイズでヒストグラムが振れやすく、誤判定が増える
- **設定の極端な偏り**: N_fast と N_slow が近すぎる（差が 2 未満）または過度に長期化（100 超）した場合、検出感度が崩れる
- **MACD 単独利用**: SMA や RSI と矛盾した場合に MACD だけで判断することは禁止。必ず整合・矛盾を判定し、矛盾時は注意喚起または見送りを優先する
## 12. 類似度計算設定（StrategyNote 用）

MACD の特性に基づき、StrategyNote 検索時に使用する類似度パラメータを以下に定義する。

### 比較タイプ
- **similarityType**: `directional`
- MACDはモメンタム・方向性を示すため、絶対値よりも符号・傾き・相対位置を重視した比較を行う

### サブ特徴量と重み
MACD は複数の構成要素を持つため、サブ特徴量ごとに重みを設定する。

| サブ特徴量 | 重み | 説明 |
|-----------|------|------|
| histogramSign | 0.30 | ヒストグラムの符号（正/負）一致。同符号=1.0、異符号=0.0 |
| histogramSlope | 0.25 | ヒストグラム増減傾向の一致（増加中/減少中/横ばい） |
| zeroLinePosition | 0.25 | 0ライン上/下の位置一致。同じ側=1.0、異なる側=0.0 |
| macdSlope | 0.20 | MACDライン自体の傾き方向の一致 |

### 許容閾値
- **histogramTolerance**: ヒストグラム傾き比較時の変化率許容幅 ±15%
- **slopeTolerance**: 傾き方向判定の閾値（例: 変化率 ±0.5% 以下は「横ばい」扱い）

### 総合重み
- **indicatorWeight**: `0.8`
- MACD は補助指標のため、RSI/SMA より若干低い重みを設定

### 方向ボーナス/ペナルティ
- SMA傾き方向との一致時: +15% ボーナス
- SMA傾き方向との不一致時: -20% ペナルティ（矛盾フラグ考慮）

### 実装ノート
```typescript
// MACD 類似度計算の概念コード
interface MACDSimilarityInput {
  histogramSign: 'positive' | 'negative';    // ヒストグラム符号
  histogramSlope: 'increasing' | 'decreasing' | 'flat'; // 増減傾向
  zeroLinePosition: 'above' | 'below';       // 0ライン位置
  macdSlope: 'up' | 'down' | 'flat';         // MACDライン傾き
}

function calculateMACDSimilarity(
  current: MACDSimilarityInput,
  reference: MACDSimilarityInput
): number {
  let score = 0;
  
  // ヒストグラム符号一致 (30%)
  score += (current.histogramSign === reference.histogramSign ? 1 : 0) * 0.30;
  
  // ヒストグラム傾き一致 (25%)
  score += (current.histogramSlope === reference.histogramSlope ? 1 : 0.3) * 0.25;
  
  // 0ライン位置一致 (25%)
  score += (current.zeroLinePosition === reference.zeroLinePosition ? 1 : 0) * 0.25;
  
  // MACDライン傾き一致 (20%)
  score += (current.macdSlope === reference.macdSlope ? 1 : 0.3) * 0.20;
  
  return score; // 0.0 ~ 1.0
}
```