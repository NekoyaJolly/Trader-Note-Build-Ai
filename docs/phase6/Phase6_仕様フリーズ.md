# Phase6 仕様フリーズ宣言

**発行日**: 2025年12月27日  
**対象プロジェクト**: TradeAssist MVP  
**文書バージョン**: 1.1.0  
**ステータス**: 正式確定（最終調整済み）

---

## 目的

本文書は **TradeAssist MVP** の機能仕様を本番リリース前提で確定し、Phase7 以降における仕様変更を禁止する。

---

## Phase6 完了条件（Exit Criteria）

✅ 以下のすべてを満たした時点で Phase6 完了とする。

1. **本文書が正式承認されている**
2. **トレードノート生成フローが確定している**
3. **判断モード推定ロジックが確定している**
4. **時間足選択仕様が確定している**
5. **エラーハンドリング設計が確定している**
6. **本番向け非機能要件が明文化されている**
7. **本番データ保護ルールが明記されている**

---

## 1. トレードノート生成フロー【確定】

### 1.1 入力

* **データソース**: CSV ファイル（手動インポート）
* **必須フィールド**:
  - `timestamp` (DateTime)
  - `symbol` (String)
  - `side` (TradeSide: buy / sell)
  - `price` (Decimal, 18,8)
  - `quantity` (Decimal, 18,8)
* **オプションフィールド**:
  - `fee` (Decimal, 18,8)
  - `exchange` (String)

### 1.2 処理フロー

```
[1] CSV 読み込み
  ↓
[2] Trade レコード作成 (Trade テーブルに INSERT)
  ↓
[3] 特徴量抽出 (FeatureExtractor による 7 次元ベクトル生成)
  ↓
[4] AI 要約生成 (AISummaryService による日本語要約)
  ↓
[5] TradeNote レコード作成 (TradeNote テーブルに INSERT)
  ↓
[6] AISummary レコード作成 (AISummary テーブルに INSERT)
```

### 1.3 特徴量ベクトル定義（固定）

**次元数**: 7（固定）

```typescript
[
  [0] 価格変化率 (-1.0 〜 1.0)
  [1] 正規化取引量 (0 〜 1.0)
  [2] RSI (0 〜 1.0 に正規化)
  [3] MACD (-1.0 〜 1.0 に正規化)
  [4] トレンド方向 (-1: 下降, 0: 横ばい, 1: 上昇)
  [5] ボラティリティ (0 〜 1.0)
  [6] 時間帯フラグ (0: 通常, 1: オープン/クローズ付近)
]
```

### 1.4 AI 要約仕様

* **使用モデル**: `gpt-4o-mini`（デフォルト）
* **最大トークン数**: 150
* **出力形式**: 日本語 3〜5 行の簡潔な要約
* **フォールバック**: API キー未設定時は基本要約を使用
* **位置づけ**: Draft（下書き）扱い。ユーザーは承認・修正が可能
* **判断への影響**: AI 要約は判断の参考情報であり、スコア計算には使用しない

### 1.5 確定事項

* **Phase7 以降、本フローの変更は禁止**
* 特徴量の次元数、順序、計算式の変更は禁止
* AI プロンプトテンプレートの変更は禁止
  
## 1.6 トレードノート再生成禁止ルール【確定】

- 一度生成された TradeNote / AISummary / FeatureVector は再生成しない
- 後続処理（判定・通知）は既存データを参照するのみ
- 再生成が必要な場合は「新しい TradeNote を作成」する

理由：
- 過去の判断根拠の再現性を保証するため
- 時点依存ロジックの破壊を防ぐため

---

## 2. 判断モード推定【確定】

### 2.1 定義と役割分担

本システムは **ルールベーススコア計算** と **AI による説明補助** の2層構造を採用する。

**ルールベーススコア計算**:

* 特徴量ベクトルの数値比較により一致度スコアを算出する
* スコアが閾値（デフォルト 0.75）以上の場合に「一致」と判定する
* このスコアが通知判断の唯一の基準となる

**AI による説明補助（Draft）**:

* トレードノート生成時に AI 要約を生成し、AISummary テーブルに保存する
* AI 要約は「なぜこのトレードを行ったか」を人間可読な形で説明する
* **重要**: AI 要約はスコア計算に一切影響を与えない
* ユーザーは AI 要約を承認・修正できる（Draft 扱い）

### 2.2 判定ロジック（ルールベース）

**トレンド一致判定**（`trendMatched`）:

```typescript
// TradeNote の featureVector[4] と MarketSnapshot の featureVector[4] を比較
noteVector[4] === marketVector[4]  // -1, 0, 1 の完全一致
```

**価格レンジ一致判定**（`priceRangeMatched`）:

```typescript
// 価格変化率の差が 10% 以内
Math.abs(noteVector[0] - marketVector[0]) <= 0.1
```

### 2.3 スコア計算（ルールベースのみ）

**重要原則**: スコア計算は完全にルールベースであり、AI や機械学習は使用しない。

**加重平均方式**（総和 1.0）:

```typescript
const FEATURE_WEIGHTS = {
  priceChange: 0.2,
  volume: 0.15,
  rsi: 0.2,
  macd: 0.15,
  trend: 0.1,
  volatility: 0.1,
  timeFlag: 0.1,
};
```

**最終スコア**:

```typescript
score = Σ (weight × partial_score)
```

### 2.4 閾値

* **デフォルト閾値**: `0.75`
* **環境変数**: `MATCH_THRESHOLD`（オーバーライド可能）

### スコアの意味定義【固定】

- スコアは「過去ノートと現在市場の数値的近さ」を表す
- 勝率・期待値・利益を直接示すものではない
- 判断責任は常にユーザーに帰属する

### 2.5 確定事項

* **スコア計算は完全にルールベースであり、AI は使用しない**
* **AI 要約は説明補助（Draft）であり、判断には影響しない**
* **Phase7 以降、重みと閾値の変更は禁止**
* ルールベースロジックの追加・変更は禁止
* ML モデルの導入は禁止

---

## 3. 時間足選択【確定】

### 3.1 設計方針

**ユーザー選択可能性**:

* ユーザーは主要時間足を1つ選択する（必須）
* 補助時間足を最大2つまで追加選択できる（オプション）
* **合計最大3つの時間足**を同時に使用可能

**MVP 制限**:

* **Phase7 時点では 15m と 1h のみサポート**
* 将来的には 5m, 30m, 4h, 1d などの追加を検討可能（Phase11 完了後）

### 3.2 対応時間足（MVP）

**本番環境で使用する時間足**:

| 時間足 | 用途 | 優先度 | MVP実装 |
|--------|------|--------|----------|
| `15m`  | 主要判定 | 最優先 | ✅ |
| `1h`   | 補助判定 | 次点 | ✅ |
| `5m`   | 短期判定 | 低 | ❌（Phase11後）|
| `4h`   | 長期判定 | 低 | ❌（Phase11後）|

### 3.3 判定方式

* **主要時間足（例: 15m）を主軸として判定を行う**
* **補助時間足（例: 1h）は文脈確認に使用する**
* **同一銘柄に対して選択された全時間足で MarketSnapshot を取得する**
* **スコア計算は時間足ごとに独立して行う**
- 複数時間足のスコアを合算・平均することは禁止
- 通知判断は主要時間足のスコアのみで行う

### 3.4 データ取得頻度

* **15m**: 15 分ごと
* **1h**: 60 分ごと

### 3.5 確定事項

* **MVP（Phase7〜11）では 15m と 1h のみサポート**
* **ユーザー選択可能な時間足は最大3つ**
* **Phase7 以降、時間足の追加は Phase11 完了後のみ検討可能**
* 時間足選択 UI の実装は Phase11 完了後に検討

---

## 4. エラーハンドリング & 通知設計【確定】

### 4.1 エラー分類

| エラー種別 | 重要度 | 対処方針 |
|-----------|--------|---------|
| **Market Data API エラー** | High | リトライ 3 回 → 失敗時スキップ |
| **AI API エラー** | Medium | 基本要約にフォールバック |
| **DB 接続エラー** | Critical | アプリケーション停止 |
| **CSV パースエラー** | Medium | 該当行スキップ + ログ出力 |

### 4.2 通知ロジック

**通知判断の唯一の基準**:

* **ルールベーススコアのみを使用**
* AI 要約や AI 推定は通知判断に使用しない
* DailyImportStatus の実行結果に基づき、成功時のみ通知を生成する

**通知発火条件**:

```typescript
score >= threshold && !isDuplicate && dailyJobSuccess
```

**重複防止（冪等性保証）**:

```typescript
// NotificationLog テーブルで一意性を保証
unique([noteId, marketSnapshotId, channel])
```

**通知チャネル**:

* **Phase7 時点では `in_app` のみ実装**
* `push` / `webhook` は Phase8 以降で検討

### 4.3 通知クールダウン

* **同一 noteId に対して 24 時間以内の再通知は禁止**
* **NotificationLog.sentAt でクールダウン判定を行う**

### 4.4 ログ保持

* **NotificationLog**: 永続保持（削除禁止）
* **Notification**: ユーザーが削除可能
* **MatchResult**: 永続保持（削除禁止）

### 4.5 確定事項

* **Phase7 以降、通知ロジックの変更は禁止**
* 新規通知チャネルの追加は Phase8 以降で検討
* 既存の冪等性保証を破壊する変更は禁止

---

## 5. 本番向け非機能要件【確定】

### 5.1 環境変数一覧

#### バックエンド（Railway）

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `DB_URL` | ✅ | - | PostgreSQL 接続文字列 |
| `NODE_ENV` | ✅ | `production` | 実行環境 |
| `PORT` | ✅ | `3100` | API ポート |
| `AI_API_KEY` | ✅ | - | OpenAI API キー |
| `AI_MODEL` | ⬜ | `gpt-4o-mini` | AI モデル名 |
| `AI_BASE_URL` | ⬜ | `https://api.openai.com/v1` | AI API ベース URL |
| `MARKET_API_URL` | ✅ | - | 市場データ API URL |
| `MARKET_API_KEY` | ✅ | - | 市場データ API キー |
| `MATCH_THRESHOLD` | ⬜ | `0.75` | 一致判定閾値 |
| `CHECK_INTERVAL_MINUTES` | ⬜ | `15` | 判定実行間隔（分） |
| `CRON_ENABLED` | ✅ | `false` | 日次ジョブ有効化 |

#### フロントエンド（Vercel）

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `NEXT_PUBLIC_API_BASE_URL` | ✅ | - | バックエンド API の URL |
| `NODE_ENV` | ✅ | `production` | 実行環境 |

### 5.2 日次ジョブ実行方針

**実行タイミング**:

* **UTC 00:00**（日本時間 09:00）
* **Railway Cron 機能を使用**

**ジョブ内容**:

1. 前日の MarketSnapshot を取得
2. 全 TradeNote に対して MatchResult を評価（ルールベーススコア計算）
3. 閾値以上の場合に Notification + NotificationLog を作成
4. DailyImportStatus に実行結果を記録
5. **DailyImportStatus が成功の場合のみ通知を配信**

**失敗時の対処**:

* **3 回リトライ**
* **失敗時は NotificationLog に `failed` ステータスを記録**
* **システム管理者に通知（将来実装）**

### 5.3 ログ・通知の最小保証

**ログレベル**:

* **本番環境**: `INFO` 以上
* **ステージング**: `DEBUG` 以上

**ログ出力先**:

* **Railway 標準出力**（永続化は Railway 側で管理）

**ログフォーマット**:

```
[timestamp] [level] [service] message
```

**通知の最小保証**:

* **通知は 99% の確率で配信される**（ベストエフォート）
* **失敗時は NotificationLog に記録され、手動再送可能**

### 5.4 確定事項

* **Phase7 以降、環境変数の削除・名称変更は禁止**
* 新規環境変数の追加は最小限にとどめる
* 日次ジョブの実行時刻変更は Phase10 まで禁止

---

## 6. 本番データ保護ルール【確定】

### 6.1 破壊的操作の禁止

**本番環境で以下の操作は絶対に禁止**:

```bash
# ❌ 絶対に実行してはいけないコマンド
npx prisma migrate reset
npx prisma db push --accept-data-loss
npx prisma db seed --reset
```

**理由**:

* **全データが削除される**
* **ユーザーの履歴が失われる**
* **復旧不可能**

### 6.2 append-only 原則

**本番環境では以下のみ許可**:

* `INSERT`（新規レコード追加）
* `UPDATE`（既存レコードの部分更新、ただし履歴は残す）

**以下は原則禁止**:

* `DELETE`（物理削除）
* `TRUNCATE`（テーブル全削除）
* `DROP TABLE`（テーブル削除）

**例外**:

* **ユーザーが明示的に削除を要求した Notification レコード**（論理削除推奨）

### 6.3 マイグレーション実行ルール

**本番環境でのマイグレーション実行**:

```bash
# ✅ 許可されているコマンド
npx prisma migrate deploy
```

**前提条件**:

* **ローカル環境でマイグレーションをテスト済み**
* **ステージング環境でマイグレーションをテスト済み**
* **ロールバック手順を事前に確認済み**

**禁止事項**:

* **本番環境で初めてマイグレーションを実行する**
* **マイグレーションファイルを直接編集する**

### 6.4 バックアップ方針

**バックアップ頻度**:

* **Railway の自動バックアップを有効化**（日次）
* **重要な操作前に手動バックアップを取得**

**リストア手順**:

* **Railway ダッシュボードから手動リストア**
* **リストア後は必ず整合性チェックを実施**

### 6.5 確定事項

* **Phase7 以降、本番 DB への破壊的操作は絶対禁止**
* **本ルールに違反した場合、即座にロールバックを実施**
* **本ルールの例外追加は Phase11 完了後のみ検討可能**

---

## 7. Phase7 以降の変更禁止事項【明示】

**以下の変更は Phase7〜Phase11 において絶対に禁止**:

### 7.1 機能変更禁止

* ❌ 新機能の追加
* ❌ 既存機能の仕様変更
* ❌ UI/UX の大幅な変更
* ❌ API レスポンス形式の変更

### 7.2 ロジック変更禁止

* ❌ 特徴量ベクトルの次元・順序・計算式の変更
* ❌ スコア計算の重みと閾値の変更
* ❌ 一致判定ロジックの変更
* ❌ 通知ロジックの変更

### 7.3 データモデル変更禁止

* ❌ テーブル構造の変更（カラム追加・削除・名称変更）
* ❌ Enum 定義の変更
* ❌ リレーション構造の変更

### 7.4 環境変数変更禁止

* ❌ 環境変数の削除
* ❌ 環境変数の名称変更
* ❌ 環境変数のデフォルト値変更（バグ修正を除く）

### 7.5 例外

**以下のみ許可**:

* ✅ バグ修正（ただし仕様変更を伴わないもの）
* ✅ パフォーマンス改善（ただし動作が変わらないもの）
* ✅ セキュリティ修正（緊急時のみ）
* ✅ ログ出力の追加（既存ロジックに影響しないもの）

---

## 8. Phase6 完了チェックリスト

**以下をすべて確認し、✅ をつけた時点で Phase6 完了とする**:

- [ ] 本文書が正式承認されている
- [ ] トレードノート生成フローが本文書に記載され、確定している
- [ ] 判断モード推定ロジック（ルールベース）が確定している
- [ ] 時間足選択（15m / 1h）が確定している
- [ ] エラーハンドリング設計が確定している
- [ ] 本番向け非機能要件（環境変数・日次ジョブ）が明文化されている
- [ ] 本番データ保護ルール（migrate reset 禁止・append-only）が明記されている
- [ ] Phase7 以降の変更禁止事項が明示されている
- [ ] 全ステークホルダーが本文書を確認し、承認している

---

## 9. 承認

**本文書の承認をもって Phase6 完了とする**。

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトオーナー | - | - | - |
| テクニカルリード | - | - | - |
| Phase6 担当エージェント | Phase6 Agent | 2025年12月27日 | ✅ |

---

## 10. 改訂履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0.0 | 2025年12月27日 | 初版発行（Phase6 仕様フリーズ確定） | Phase6 Agent |
| 1.1.0 | 2025年12月27日 | 最終調整（判断モード推定明確化、時間足仕様正確化、AI Draft位置づけ明示、通知判断基準追加） | Phase6 Final Agent |

---

**以上**
