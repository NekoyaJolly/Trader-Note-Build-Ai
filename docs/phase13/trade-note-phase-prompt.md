# TradeNote 実装フェーズ計画 & Phase別指示書

本ドキュメントは、**現状プロジェクトの進捗を踏まえ**、本チャットで合意した大規模実装を
**実装 → 動作確認完了**まで導くためのフェーズ計画と、
**Phase 単位でそのまま実行できる指示書**をまとめたものである。

---

## 0. 現状サマリー（2025-12 時点）

### すでに合意・確定していること
- 技術スタック選定（①〜⑨ 全確定）
- TimescaleDB / PostgreSQL 採用
- indicatorts（TypeScript）採用
- Layer1〜Layer3 ノート構造
- pgvector による類似検索
- BullMQ による再評価パイプライン
- OpenAI API によるサマリー生成
- 思想ノート（Living Intent）確定

### 未実装領域
- CSV 取引履歴インポート
- 市場データ取得
- 指標計算・ノート生成パイプライン
- 類似検索・通知
- UI

---

# Phase 0 : 基盤準備（必須）

## 目的
- 実装を安全に進められる土台を作る

## 実装指示
1. **環境統一**
   - Node.js 22+ / TypeScript
 

1. **DB 構築**
   - Railway PostgreSQL 作成
   - TimescaleDB 拡張有効化
   - pgvector 拡張有効化（未使用でも導入）

2. **CI 基盤**
   - GitHub Actions
     - lint
     - typecheck
     - test

## 完了条件
- CI が green
- DB に接続可能

---

# Phase 1 : トレード履歴インジェスト

## 目的
- 取引履歴を「定義されたトレード」として保存する

## 実装指示
1. CSV パーサ
   - csv-parser
   - ストリーム処理

2. Trade 定義
   - entry / exit マッチング
   - 部分決済対応

3. 永続化
   - trades テーブル
   - raw_import_logs

## 完了条件
- CSV → DB 登録成功
- 不正 CSV を安全にスキップ

---

# Phase 2 : 市場データ & 時系列管理

## 目的
- トレード時点の市場状態を再構築できるようにする

## 実装指示
1. 市場データ API クライアント
2. OHLC 保存（TimescaleDB）
3. BarLocator
   - exact / nearest
   - 祝日・ギャップ対応

## 完了条件
- 指定トレード時点のバー取得成功

---

# Phase 3 : インジケーター計算（Layer1 / Layer2）

## 目的
- indicatorts による再現可能な指標計算

## 実装指示
1. indicatorts 統合
2. 基本インジケーター20種対応
3. Layer1 保存（生値・パラメータ）
4. Layer2 保存（特徴量）

## 完了条件
- 指標値が再計算可能
- テストで数値妥当性確認

---

# Phase 4 : ノート生成（Layer3）

## 目的
- 人間が読めるトレードノートを生成

## 実装指示
1. NoteBuilder 実装
2. OpenAI API 統合
3. テンプレートフォールバック
4. JSONB 保存

## 完了条件
- ノートが自動生成される
- 再生成可能

---

# Phase 5 : 類似トレード検索

## 目的
- 過去ノートとの類似性評価

## 実装指示
1. 特徴量正規化
2. pgvector 保存
3. 類似検索 API

## 完了条件
- 類似トレードが取得できる

---

# Phase 6 : 再評価・再生成パイプライン

## 目的
- 定義変更に耐える設計

## 実装指示
1. BullMQ 導入
2. 再評価ジョブ定義
3. 再生成ワークフロー

## 完了条件
- 過去ノートを一括再生成可能

---

# Phase 7 : UI / 通知

## 目的
- ユーザー体験の完成

## 実装指示
1. ノート一覧 UI
2. 類似性通知
3. 2タッチ注文導線

## 完了条件
- 通知 → 注文パネルまで到達可能

---

# 動作確認チェックリスト

| Phase | 完了 |
|------|------|
| 0 | ☐ |
| 1 | ☐ |
| 2 | ☐ |
| 3 | ☐ |
| 4 | ☐ |
| 5 | ☐ |
| 6 | ☐ |
| 7 | ☐ |

---

## 補足
- 本ドキュメントは **Agent / 人間共通の実行計画書** とする
- 各 Phase は完了後にのみ次へ進む
- 思想ノートと矛盾する実装は禁止

