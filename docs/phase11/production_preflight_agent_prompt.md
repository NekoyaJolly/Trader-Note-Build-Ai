# 本番前チェック完全実行 Agent 用プロンプト（Preflight Verification）

## 目的
本プロンプトは、**ローカル実装済みの TradeAssist プロジェクトを本番環境（Vercel + Railway）へ安全に移行するため**、
既知の重大事故 20 ケースを **すべて検証・是正** することを目的とする。

本タスクは **設計・思想の変更を一切行わず**、
「本番で事故が起きない状態」を作ることにのみ集中する。

---

## 実行原則（厳守）

- 新機能追加禁止
- 仕様変更禁止
- Prisma schema / migration 変更禁止（※不具合修正のみ例外）
- UI 文言の意味変更禁止（誤解防止の微修正は可）
- すべての修正は **理由を日本語コメントで明示**
- 不明点・判断が必要な場合は **実装せずコメントで報告**

---

## 対象環境

- Frontend: Vercel（Production）
- Backend / DB / Cron: Railway（Production）
- ORM: Prisma
- Runtime: Node.js

---

## 検証対象（必須）

以下 **20 ケースを上から順に必ず検証** し、

- 問題なし → OK
- 問題あり → 修正 + 修正内容記録

を行うこと。

---

## チェックリスト（S級）

### 1. 環境変数完全一致
- DB_URL / DATABASE_URL の混在がないか
- Vercel / Railway 両方に正しく設定されているか
- 未使用の env が残っていないか

### 2. テスト・サンプルデータ遮断
- sample CSV / test script が本番で実行されないか
- 本番 DB に test 用レコードが存在しないか

### 3. Cron 二重起動防止
- Railway Cron が 1 系統のみか
- 再デプロイで重複登録されないか

### 4. 例外露出防止
- StackTrace / Prisma Error が UI に露出しないか
- 本番用エラーメッセージに統一されているか

### 5. 認可境界検証（IDOR）
- notes / notifications の取得時に userId チェックがあるか
- 他ユーザーのデータにアクセスできないか

---

## チェックリスト（A級）

### 6. 初回オンボーディング制御
- 本番で無限表示されないか
- Cookie / localStorage 判定が正しいか

### 7. Empty State 明示
- データが無い日の文言が表示されるか
- 取得失敗と「取引なし」が区別されているか

### 8. CSV インポート本番互換
- ファイルサイズ制限
- UTF-8 / BOM 対応
- MIME type

### 9. タイムゾーン整合性
- DB / API / UI の日付が一致するか
- JST/UTC 混在がないか

### 10. バッチ失敗可視化
- 日次処理失敗時に UI / ログで追跡できるか

---

## チェックリスト（B級）

### 11. Draft / Approved 整合
- 承認状態が即時反映されるか
- キャッシュ不整合がないか

### 12. 通知頻度制御
- 本番データ量でスパムにならないか
- 閾値が意図通りか

### 13. ユーザー向け文言
- 開発者向け表現が残っていないか

### 14. Mobile 実機確認
- モーダル操作可能か
- 主要画面が崩れていないか

### 15. 発注誤解防止
- 自動売買と誤解されない表現か

---

## チェックリスト（C級）

### 16. ログ量
- debug / verbose log が無効化されているか

### 17. migrate / reset 安全性
- 本番で reset 系が実行されないか

### 18. AI ノート vs ユーザー補足
- UI 上で明確に区別されているか

### 19. 外部 API 制限
- レート制限対策が最低限あるか

### 20. 仮コード残存
- TODO / placeholder が実行されないか

---

## 修正ルール

- 修正は **最小差分**
- 影響範囲をコメントで明示
- 修正理由を必ず日本語で記録

---

## 完了報告フォーマット（必須）

```text
[Preflight Check 完了報告]

- ケース1〜5（S級）: 全てOK / 修正あり（詳細）
- ケース6〜10（A級）: 全てOK / 修正あり（詳細）
- ケース11〜15（B級）: 全てOK / 修正あり（詳細）
- ケース16〜20（C級）: 全てOK / 修正あり（詳細）

未対応項目（あれば）:
- 理由:
- 人間判断が必要な点:
```

---

## 最重要メッセージ

このタスクは「速さ」より **安全性と再現性** を最優先する。

> 動けば良い、は不可。
> 本番で“静かに壊れない”ことが合格条件。

以上を厳守して実行せよ。

