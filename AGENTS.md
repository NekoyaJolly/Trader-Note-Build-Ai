## 目的

このファイルは **Trader-Assist-MVP** プロジェクトにおいて、AI エージェントが
「何を・どこまで・どのような品質基準で」実装すべきかを正確に理解し、
**人間のレビュー負荷を最小化しつつ安全に開発を進める** ための公式指示書です。

本ファイルは README.md よりも **優先度が高いエージェント向け仕様書** です。
AI エージェントは、作業開始前に必ず全文を読み、遵守してください。

---

## 最重要ルール（必ず守ること）

### 1. 出力・記述言語ルール（★最優先）

**このリポジトリ内で生成・編集するすべての成果物について、以下を必須とします。**

* コメント、説明文、README、Doc、AGENTS.md 参照箇所は **日本語で記述すること**
* ソースコード内コメントも **原則すべて日本語**
* 例外として以下のみ英語可

  * プログラミング言語の予約語
  * ライブラリ・フレームワーク固有の英語 API 名
  * 公式仕様で英語が必須な設定キー

❌ 禁止事項

* 英語のみのコメント
* 日本語コメント無しでのロジック実装
* README や docs に英語説明のみを追加する行為

---

## プロジェクト概要

本プロジェクトは **TradeAssist MVP** を構築します。
目的は以下の機能を最小構成で実現することです。

* 実トレード履歴からの **自動トレードノート生成**（構造化 + AI 要約）
* リアルタイム市場データとの **一致判定（ルールベース）**
* 通知および **発注支援 UI**（自動売買は禁止）
* MVP 検証を最優先とした安全設計

エージェントは「勝率を上げる自動売買」を目的にしてはいけません。
本プロジェクトは **判断の質を高める支援ツール** です。

---

## 技術スタック

* **Backend**: Python (FastAPI) または Node.js
* **Frontend**: TypeScript + Next.js
* **Database**: PostgreSQL（TimescaleDB optional）
* **AI**: OpenAI API（軽量モデル優先）
* **Market Data**: サードパーティ API（例: Twelve Data）
* **Notification**: Firebase / OneSignal

---

## 環境変数ルール

`.env` ファイルに定義し、**絶対にコミットしない**。

```
DB_URL=...
AI_API_KEY=...
MARKET_DATA_API_KEY=...
NOTIFICATION_CONFIG=...
```

❌ 禁止

* API キーやトークンをコードに直接書く
* サンプルとしてでも実値を含める

---

## ディレクトリ構造（遵守）

```
/src
  /backend
    /api        # エンドポイント定義
    /services   # ビジネスロジック
    /models     # DB / スキーマ
    /tests
  /frontend
    /components
    /pages
    /styles
    /tests
/docs
AGENTS.md
README.md
```

---

## コーディング規約

### 共通

* 関数・変数名は意味が分かる名称を使用
* 1ファイル1責務を意識
* マジックナンバー禁止（定数化）

### コメントルール（重要）

* **なぜこの処理が必要か** を必ず日本語で説明
* 処理の前提条件・制約・副作用をコメントで明示

✅ 良い例

```ts
// RSI が一定以下の場合のみエントリー候補とする
if (rsi < RSI_THRESHOLD) {
  ...
}
```

❌ 悪い例

```ts
if (rsi < 30) {
  ...
}
```

---

## テストポリシー

* ロジック追加時は必ずテスト追加
* 一致判定ロジックは **正常系 / 境界値 / 異常系** を含める
* テストコメントも日本語

```
pytest
npm test
```

テスト未実装の PR は **未完了扱い** とします。

---

## フェーズ進行ルール

* Phase0 → Phase5 の順序を厳守
* 前フェーズの成果物が存在しない場合、次へ進まない
* フェーズ定義は Canvas 上の「TradeAssist MVP まとめ」に従う
* Phase6 以降は「本番デプロイまでの公式 Phase Flow」に従う

---

## 本番デプロイまでの公式 Phase Flow

**このセクションは Phase6〜Phase11 の実行ルールを定義します。**

### 共通原則

* **Phase 番号順に実行すること**（飛ばし禁止）
* **各 Phase の Exit Criteria を満たすまで次へ進まない**
* **Phase6 以降は仕様変更を禁止**（実装のみに集中）
* **本番 DB への破壊的操作を絶対に禁止**（migrate reset / seed 実行不可）
* **デプロイ先は Vercel（UI）+ Railway（API / DB）を前提とする**

---

### Phase 6：本番前最終仕様固定（Freeze Phase）

**目的**
「これ以上変えない」範囲を明確にし、実装ブレを止める。

#### Step 6-1：仕様フリーズ宣言

* トレードノート生成フロー確定
* 判断モード推定（順張り / 逆張り）確定
* 時間足選択（最大3）確定
* エラーハンドリング & 通知ルール確定
* **これ以降の新機能追加・仕様変更を禁止**

#### Step 6-2：本番用非機能要件の確定

* 環境変数一覧を明記（Railway / Vercel）
* 日次ジョブ実行時刻を決定
* ログ保持方針を定義（最低限の要件のみ）

#### Step 6-3：本番データ破壊禁止ルール定義

* migrate reset 禁止を明記
* seed 実行禁止を明記
* 本番 DB は **append-only 運用** を厳守

**Exit Criteria**
✅ 「この仕様で世に出す」と宣言できる状態

---

### Phase 7：本番インフラ構築（Deploy Infra）

**目的**
コードを置く「器」を先に完成させる。

#### Step 7-1：Railway（API / DB）構築

* PostgreSQL サービス作成
* API サービス作成
* 環境変数設定を完了

  * `DB_URL`
  * `NODE_ENV=production`
  * `CRON_ENABLED=true`

#### Step 7-2：Vercel（UI）構築

* GitHub リポジトリ連携
* 環境変数設定を完了

  * `NEXT_PUBLIC_API_BASE_URL`
* Preview / Production 環境を分離

#### Step 7-3：疎通確認（空でもOK）

* UI → API `/health` 確認
* API → DB 接続確認
* **データ投入は不要**（接続のみ）

**Exit Criteria**
✅ 「空の本番環境が生きている」

---

### Phase 8：本番向け API デプロイ & 検証

**目的**
API + DB を本番品質で成立させる。

#### Step 8-1：API 本番デプロイ

* Railway に push 実行
* Prisma migrate deploy 実行
* テーブル生成を確認

#### Step 8-2：本番向け初期データ投入

* インジケーター定義を投入（RSI / SMA / BB / MACD）
* マスターデータのみ投入
* **トレードデータは投入しない**

#### Step 8-3：API 単体動作確認

* `/notifications` エンドポイント（空配列）
* `/daily-status` エンドポイント（未実行）
* エラー時ログ出力を確認

**Exit Criteria**
✅ 「API は一人で立っている」

---

### Phase 9：UI 本番デプロイ & 結合確認

**目的**
ユーザー視点で「使える形」にする。

#### Step 9-1：UI 本番デプロイ

* Vercel Production Deploy 実行
* API Base URL を本番用に切替
* ビルドエラーゼロを確認

#### Step 9-2：UI → API 結合確認

* 通知一覧表示を確認（0件）
* エラーバナー表示テスト
* 設定画面遷移確認

#### Step 9-3：UX 破綻チェック

* 何もない状態で違和感がないか確認
* 通知がうるさくないか確認
* 空状態の文言を確認

**Exit Criteria**
✅ 「触って嫌じゃない」

---

### Phase 10：本番データ流入テスト（限定）

**目的**
「本当にノートができるか」を確認する。

#### Step 10-1：本番用 CSV インポート（手動）

* 1日分のみ投入
* CLI / 管理画面経由で実行
* ログを詳細確認

#### Step 10-2：日次ジョブ手動実行

* ノート下書き生成を確認
* DailyImportStatus 記録を確認
* エラー通知挙動を確認

#### Step 10-3：UI で承認フロー確認

* ノート表示を確認
* AI 推定表示を確認
* 承認 / 修正フローを確認

**Exit Criteria**
✅ 「このアプリ、ちゃんと意味がある」

---

### Phase 11：本番リリース宣言（Soft Launch）

**目的**
「使い始められる状態」にする。

#### Step 11-1：自動日次処理 ON

* Railway Cron を有効化
* 失敗通知をテスト

#### Step 11-2：運用ルール確定

* 障害時の対応手順を定義
* ロールバック基準を定義
* DB バックアップ頻度を定義

#### Step 11-3：リリース宣言

* 「知り合いに使ってもらえる」状態を確認
* 機能追加は次フェーズへ

**Exit Criteria**
✅ **本番デプロイ完了**

---

## デプロイ・運用ルール

* CI/CD を必ず通す
* ステージング環境で確認後に本番
* 本番環境向け変更は **人間の明示承認が必要**

---

## AI エージェントの行動制約

### Allowed

* ファイル読み取り
* テスト実行
* コード生成（日本語コメント必須）

### Ask First（人間確認必須）

* 新規ライブラリ追加
* git push / release
* 本番デプロイ

---

