# EMA 定義書（Exponential Moving Average）

本定義は TradeAssist における EMA（指数平滑移動平均線）の公式ドキュメントであり、SMA 定義書と同一構造で記述する。数値と語彙を三層で分離し、マッチング・ノート生成・通知で一貫して利用する。

## メタ情報（管理用）
- indicator_id: `ema`
- カテゴリ: trend（トレンド系）
- 定義バージョン: 1.0.0
- 導入日: 2025-06-15

## 1. インジケーター概要
- 直近の価格により大きな重みを与える移動平均線。SMA より価格変動への反応が速い
- 標準期間は 12 と 26（MACD と連携）。本プロジェクトでは終値ベースで算出し、複数期間の組み合わせもユーザー設定で許可する
- EMA は MACD の内部計算でも使用されるため、整合性を保つことが重要
- 計算式: EMA[t] = price[t] × α + EMA[t-1] × (1 - α)、α = 2 / (N + 1)

## 2. 想定トレーダーペルソナ
- SMA より早いシグナルを求める短期〜中期トレーダー（経験 2〜5 年、リスク許容度: 中〜高）
- 価格変動への素早い反応を重視し、トレンド転換の初期段階を捉えたいスタイル
- MACD と組み合わせてモメンタム分析を行う実践的なアプローチ

## 3. 対応トレードスタイル（スキャル / デイ）
- スキャル: 1〜5 分足で短期期間（5・9・12）を使用。SMA より反応が速く、ノイズも拾いやすい点に注意
- デイ: 15〜60 分足で標準期間（12・26）を使用。MACD と組み合わせてトレンド判断を強化

## 4. 生データとして記録する項目（Layer1）
- 時系列終値（必須）、時間足（例: 1m/5m/15m/60m/1h）、期間 N（標準: 12 と 26）
- 価格取得元: 市場データ API（終値精度は少なくとも小数第 2 位まで保持）
- 欠損補填: 終値欠損時はその足を無視し、連続欠損 2 本以上で算出停止とする
- タイムゾーン: UTC で保存し、表示時にユーザータイムゾーンへ変換
- 複数期間対応: 各期間 N ごとに独立した EMA 値を記録。期間間の関係性は Layer2 で計算
- 初期値: 最初の N 本は SMA を使用し、それ以降 EMA 計算に切り替える

## 5. 判断コンテキスト（Layer2）
- **現在の EMA 値**: 期間 N に対する指数平滑移動平均値（実数値）
- **傾き（トレンド方向）**: EMA[t] − EMA[t-1]（1 本分の勾配）、および直近 5 本の平均傾き
- **傾き方向判定**: 正傾き→「上向きトレンド」、負傾き→「下向きトレンド」、絶対傾き < 0.05 かつ 3 本連続→「横ばい」
- **価格とEMAの乖離**:
  - 絶対乖離: price − EMA（正値: 価格が上、負値: 価格が下）
  - 乖離率: 正規化乖離 = (price − EMA) / EMA × 100（パーセント）
- **SMA との比較**:
  - EMA と同期間 SMA の差分: EMA - SMA（正値: EMA が上、価格反応が速い状態）
  - 差分率: (EMA - SMA) / SMA × 100
- **クロスイベント**:
  - 価格クロス: 価格が EMA を上抜け/下抜けした事実、経過本数
  - EMA クロス: EMA12 と EMA26 のクロス（MACD のゼロクロスと同義）
- **MACD との整合**: EMA12 - EMA26 = MACD ライン値との一致確認

## 6. 言語化レイヤー（Layer3）
- **「上向きトレンド発生」** = 傾き > tol_slope かつ直近 3 本連続正傾き
- **「下向きトレンド発生」** = 傾き < -tol_slope かつ直近 3 本連続負傾き
- **「トレンド継続中」** = 傾き方向が 5 本以上保持
- **「トレンド転換の兆し」** = 傾き反転が 1〜2 本で発生し、前トレンド方向が 5 本以上継続していた場合
- **「EMA が SMA を上回る」** = 価格が上昇トレンドに加速している兆候
- **「EMA が SMA を下回る」** = 価格が下降トレンドに加速している兆候
- **「押し目・戻り」** = トレンド方向と逆の乖離で、乖離幅が許容範囲内
- **「過度な乖離」** = 乖離率が ±3%（SMA より狭い閾値）を超過
- **「横ばい相場」** = 傾きの絶対値が tol_slope 未満で 3 本以上継続

## 7. ユーザー基準値の扱い
- **標準期間**: 12（短期）と 26（中期）を既定値。ユーザーは 5 から 200 の範囲で設定可能
- **乖離許容幅 tol_dev**（初期値: 標準偏差 × 0.4）: SMA より狭めに設定。0.2〜0.8 の範囲で変更可能
- **傾き感度 tol_slope**（初期値: 0.08）: SMA より敏感に設定。0.01〜0.3 の範囲で変更可能
- **乖離率の警告閾値**（初期値: ±3%）と極限化閾値（初期値: ±7%）
- **期間バリデーション**: 整数、5 以上 200 以下。それ以外は拒否
- **設定変更時**: Layer2 の傾き・乖離計算と Layer3 の語彙マッピング両方に即座に反映

## 8. マッチングに使用する特徴量
- 現在 EMA 値、価格との乖離（絶対・比率）、傾き（1 本分と直近 5 本平均）、傾き方向判定フラグ
- 複数期間対応: EMA12 と EMA26 のクロス有無、相互関係
- SMA との差分: 同期間 SMA との位置関係
- トレンド継続期間、直近の転換イベント有無
- **例マッチング条件**:
  - 「EMA12 が上向きで EMA26 を上抜け（ゴールデンクロス）」→ 買いシグナル
  - 「EMA が SMA を上回り、両者とも上向き」→ 強気トレンド加速
  - 「価格が EMA 上に位置し、乖離が許容範囲内」→ 押し目買い候補
- **MACD との関係**:
  - EMA12 - EMA26 = MACD ライン
  - EMA クロスは MACD のゼロラインクロスと同義

## 9. AI が利用してよい情報 / 禁止情報
- 利用可: Layer2/Layer3 の特徴量、ユーザーが設定した期間・乖離幅・傾き感度、時間足、マッチ理由のテキスト
- 禁止: 個別の生ローソク足データ（高値・安値など終値以外）、取引数量、個別銘柄名や未公開注文履歴などの個人情報
- AI 入力前に銘柄名・注文ID は匿名化し、数値特徴のみを渡す

## 10. 将来拡張時の注意点
- DEMA（二重指数平滑移動平均）や TEMA（三重指数平滑移動平均）への拡張時は、基準値の互換性を検証
- MACD の期間設定と EMA の期間設定は連動させるべき。不整合があれば警告を出す
- 複数期間の組み合わせは Layer2 レベルで明示化し、AI のマッチング根拠に含める
- SMA との比較結果は常に記録し、EMA の特性（反応速度の違い）を評価できるようにする

## 11. 本インジケーターが不適切な状況
- **レンジ相場（横ばい局面）**: EMA も SMA 同様にトレンド系のため、横ばいでは機能しにくい
- **ノイズの多い相場**: EMA は SMA より反応が速いため、ノイズを拾いやすい。ダマシに注意
- **経済指標発表前後**: 非連続な価格変動により、EMA 値が実際のトレンドを反映しない
- **極端な出来高低下時**: スプレッド拡大や流動性不足により、EMA 値が不安定になる
- **ユーザー設定の極端な偏り**: 期間が 3 未満や 300 超のような非現実的な値
- **初期データ不足**: 期間 N 未満のデータしかない場合、計算結果の信頼性が低い

## 12. 類似度計算設定（StrategyNote 用）

EMA の特性に基づき、StrategyNote 検索時に使用する類似度パラメータを以下に定義する。

### 比較タイプ
- **similarityType**: `relative`
- EMA は価格帯に依存するため、SMA と同様に相対的な位置関係で比較する

### 主要比較値
| 特徴量 | 重み | 許容範囲 | 説明 |
|-------|------|---------|------|
| deviationRate | 0.30 | ±0.8% | 価格とEMAの乖離率（SMAより狭い） |
| slopeDirection | 0.35 | - | 傾き方向（上向き/下向き/横ばい）の一致 |
| emaVsSmaPosition | 0.20 | - | EMA が SMA より上/下の位置一致 |
| trendStrength | 0.15 | ±0.15 | トレンド強度の差 |

### 許容閾値
- **deviationTolerance**: ±0.8%（SMA の ±1.0% より狭い）
  - EMA は価格に近いため、より狭い許容幅を使用
- **trendStrengthTolerance**: ±0.15

### 傾き方向分類
SMA と同じ分類を使用：
| 方向 | 条件 | 説明 |
|------|------|------|
| up | 傾き > tol_slope | 上向きトレンド |
| down | 傾き < -tol_slope | 下向きトレンド |
| flat | \|傾き\| ≤ tol_slope | 横ばい |

### 総合重み
- **indicatorWeight**: `0.9`
- EMA は SMA の補助的なトレンド指標として、SMA よりやや低い重みを設定

### EMA-SMA 関係ボーナス
EMA と SMA の相対位置が一致する場合にボーナス：
- **両方とも「EMA > SMA」**: +15% ボーナス（上昇加速一致）
- **両方とも「EMA < SMA」**: +15% ボーナス（下降加速一致）
- **関係が逆転**: -15% ペナルティ

### MACD 整合ボーナス
MACD の状態と EMA クロスが整合する場合：
- **EMA12 > EMA26 かつ MACD > 0 が一致**: +10% ボーナス
- **不整合**: -5% ペナルティ

### 実装ノート
```typescript
// EMA 類似度計算の概念コード
interface EMASimilarityInput {
  deviationRate: number;                       // 乖離率 (%)
  slopeDirection: 'up' | 'down' | 'flat';      // 傾き方向
  emaVsSmaPosition: 'above' | 'below';         // EMA が SMA より上/下
  trendStrength: number;                       // 0〜1
  ema12AboveEma26?: boolean;                   // EMA12 > EMA26
}

function calculateEMASimilarity(
  current: EMASimilarityInput,
  reference: EMASimilarityInput
): number {
  let score = 0;
  
  // 乖離率の類似度 (30%)
  const devDiff = Math.abs(current.deviationRate - reference.deviationRate);
  const devScore = Math.max(0, 1 - devDiff / 1.6); // 1.6%差で0になる
  score += devScore * 0.30;
  
  // 傾き方向一致 (35%)
  const slopeScore = calculateSlopeMatch(current.slopeDirection, reference.slopeDirection);
  score += slopeScore * 0.35;
  
  // EMA vs SMA 位置一致 (20%)
  if (current.emaVsSmaPosition === reference.emaVsSmaPosition) {
    score += 1.0 * 0.20;
  } else {
    score += 0 * 0.20; // 不一致は0点
  }
  
  // トレンド強度 (15%)
  const strengthDiff = Math.abs(current.trendStrength - reference.trendStrength);
  const strengthScore = Math.max(0, 1 - strengthDiff / 0.3);
  score += strengthScore * 0.15;
  
  // EMA-SMA 関係ボーナス/ペナルティ
  if (current.emaVsSmaPosition === reference.emaVsSmaPosition) {
    score *= 1.15; // 15%ボーナス
  } else {
    score *= 0.85; // 15%ペナルティ
  }
  
  return Math.min(1.0, score);
}

function calculateSlopeMatch(s1: string, s2: string): number {
  if (s1 === s2) return 1.0;
  if ((s1 === 'flat' || s2 === 'flat')) return 0.5;
  return 0; // up ↔ down
}
```
