# トレードノート実装｜技術スタック選定シート

本ドキュメントは、本チャット内で **すべての技術スタック選択を確定させる** ことを目的とした選定雛形である。

- 対象：取引履歴ベース自動トレードノート生成
- 前提方針：
  - 長期利用
  - 類似トレード検索・マッチング前提
  - トレードをデータ資産として永続化

本シートでは、**技術スタックの選択が不可避な項目のみ**を列挙する。
設計判断・ルール判断は別紙とする。

---

## ① トレード履歴インポート方式

### 概要
各ブローカー／プラットフォームの CSV 取引履歴を安定して取り込み、将来の API 連携にも耐える基盤を選定する。

### 選択肢
- [x] Node.js（csv-parser 等）
- [ ] Python（pandas）
- [ ] その他

### 決定内容
- 採用方式：**Node.js（TypeScript）＋ csv-parser**
- 理由：
  - 既存バックエンド（TypeScript）と統一
  - ストリーム処理で大容量 CSV に耐性
  - Docker / Railway 環境との親和性が高い

---


## ② 市場データ取得元

### 概要
エントリー／クローズ時点の市場状態を再構築するための価格データソースを決定する。

### 選択肢
- [x] 外部マーケットデータ API
- [ ] ブローカー API
- [ ] 自前収集

### 決定内容
- 採用方式：**外部マーケットデータ API（REST）**
- 方針：
  - MVP では汎用マーケットデータ API を利用
  - ブローカー API は将来オプションとして分離
- 理由：
  - 実装難易度と安定性のバランスが良い
  - 銘柄追加・横断対応が容易

---


## ③ 時系列データ保存基盤

### 概要
OHLC・出来高などの時系列データを、将来の再計算・再評価・マルチタイムフレーム展開に耐える形で保存する。

### 選択肢
- [ ] PostgreSQL
- [x] TimescaleDB（PostgreSQL 拡張）
- [ ] ファイル（Parquet / JSON）

### 決定内容
- 採用方式：**TimescaleDB（PostgreSQL 拡張）**
- 理由：
  - Railway Pro で PostgreSQL を標準利用でき、拡張で段階導入が可能
  - 時系列クエリ（期間抽出・集計・ダウンサンプリング）に強い
  - SQL／RDB のまま運用でき、学習・運用コストが低い
  - 将来のマルチタイムフレーム再計算・再評価ジョブに直結

---


## ④ インジケーター計算基盤

### 概要
RSI・SMA 等の基本指標は再現性と再計算性を最優先し、TypeScript 製インジケーターライブラリを基盤として内製計算する。特殊・ユーザー固有指標は拡張 API として分離する。

### 選択肢
- [x] TypeScript 指標ライブラリ（indicatorts）＋ 拡張 API
- [ ] フル自前実装（TypeScript）
- [ ] Python（NumPy / ta-lib）
- [ ] 外部 API のみ

### 決定内容
- 採用方式：**TypeScript 指標ライブラリ（indicatorts）＋ 拡張 API**
- 採用ライブラリ：`cinar/indicatorts`
- 方針：
  - 基本インジケーター（約20種）は indicatorts を用いて自前計算
  - 計算ロジックはアプリ内で完結させ、再計算・再評価を保証
  - 特殊指標・ユーザー固有カスタム指標は API 経由で拡張
- 理由：
  - TypeScript ネイティブで既存バックエンドと完全に統一可能
  - 外部 API 依存を排除し、計算結果の再現性が高い
  - ライブラリ更新時もラッパー層で影響を局所化できる

---



## ⑤ 特徴量（Feature）保存基盤

### 概要
将来の類似トレード検索・マッチングに耐えるよう、特徴量を再利用可能な形で保存する。

### 選択肢
- [ ] RDB JSON カラムのみ
- [ ] 正規化テーブルのみ
- [x] RDB JSONB ＋ ベクトル拡張（pgvector）

### 決定内容
- 採用方式：**PostgreSQL JSONB ＋ pgvector（段階導入）**
- 方針：
  - まずは JSONB に特徴量スナップショットを保存
  - 類似検索が本格化した段階で pgvector を有効化
- 理由：
  - Railway Pro の PostgreSQL で完結
  - スキーマ変更に強く、段階的スケールが可能
  - SQL 検索とベクトル検索を同一基盤で併用可能

---


## ⑥ 類似トレード検索方式

### 概要
過去トレードと現在・他トレードを比較し、類似性を定量評価する方式を決定する。

### 選択肢
- [ ] ルールベースのみ
- [x] ベクトル類似度検索
- [ ] ハイブリッド

### 決定内容
- 採用方式：**ベクトル類似度検索（pgvector）**
- 方針：
  - 初期はスコア閾値を高めに設定
  - 必要に応じてルール補正を追加
- 理由：
  - 特徴量設計と自然に接続できる
  - 類似検索・マッチング双方に再利用可能

---


## ⑦ 自然言語サマリー生成基盤

### 概要
トレードノートの可読性と説明責任を高めるため、構造化データから自然言語サマリーを生成する。

### 選択肢
- [ ] テンプレートベースのみ
- [x] LLM API（OpenAI）＋ テンプレートフォールバック
- [ ] ローカル LLM

### 決定内容
- 採用方式：**OpenAI API（LLM）＋ テンプレートフォールバック**
- 方針：
  - 通常は OpenAI API による生成を使用
  - API 障害・コスト制御時はテンプレート生成に自動フォールバック
  - 生成結果は必ず保存し、**再生成可能**とする
- 理由：
  - ChatGPT Plus で設計・プロンプト検証が可能
  - 実行系は API に限定し、再評価・一括再生成に対応
  - 品質と可用性の両立が可能

---


## ⑧ トレードノート永続化

### 概要
トレードノート本体（構造化データ・要約・メタ情報）を、再生成・再評価・検索に耐える形で永続化する。

### 選択肢
- [ ] JSON ファイル
- [ ] RDB
- [x] ハイブリッド（Raw JSON + 正規化）

### 決定内容
- 採用方式：**ハイブリッド（Raw JSON + 正規化）**
- 理由：
  - Raw JSON をそのまま保存し、**将来の再評価・再生成に完全対応**
  - 検索・集計・関連付けは正規化テーブルで高速化
  - PostgreSQL（Railway Pro）で完結し、運用がシンプル
  - スキーマ変更に強く、長期運用での破壊的変更を回避

---


## ⑨ 再評価・再生成パイプライン

### 概要
指標定義変更やアルゴリズム更新時に、過去ノートを安全に再評価・再生成する仕組みを構築する。

### 選択肢
- [ ] 完全同期処理
- [x] ジョブキュー（軽量）
- [ ] ワークフローエンジン

### 決定内容
- 採用方式：**ジョブキュー（BullMQ 等）**
- 方針：
  - 通常処理は同期
  - 再評価・一括再生成のみ非同期ジョブ化
- 理由：
  - 実装が軽量で Railway / Docker に適合
  - 再生成時の負荷集中を回避

---


## 決定サマリー（一覧）

| No | 項目 | 採用技術 |
|----|------|----------|
| 1 | トレード履歴インポート | Node.js（TypeScript） |
| 2 | 市場データ取得元 | 外部マーケットデータ API |
| 3 | 時系列データ保存 | TimescaleDB（PostgreSQL 拡張） |
| 4 | 指標計算基盤 | 自前実装（TypeScript）＋ 拡張 API |
| 5 | 特徴量保存 | PostgreSQL JSONB ＋ pgvector（段階導入） |
| 6 | 類似検索方式 | ベクトル類似度検索（pgvector） |
| 7 | サマリー生成 | OpenAI API ＋ テンプレートフォールバック |
| 8 | ノート保存 | ハイブリッド（Raw JSON + 正規化） |
| 9 | 再評価パイプライン | ジョブキュー（BullMQ 等） |

---

※ 本シートは「決定ログ」として保存し、後続 Agent・実装の唯一の参照点とする。



---

# プロジェクト思想ノート（Owner’s Intent / Living Document）

本セクションは、本プロジェクトにおける**設計・実装・判断の最上位指針**として扱う。
技術的最適解が複数存在する場合、本ノートに記載された思想と**矛盾しない選択**を優先する。

このノートは**固定仕様ではなく更新前提**とし、将来の判断・設計変更時の根拠として参照される。

---

## TradeNote が達成したいこと

### ユーザーが望むこと

1. トレードが自動で記録されること
2. 記録されたトレードを振り返れること
3. 記録されたトレードでバックテストできること
4. インジケーターと期間を選んでバックテストできること
5. 気に入ったテスト結果からトレードノートへエクスポートできること
6. トレードノートと類似性の高い瞬間に通知が来ること
7. 通知確認後、**2タッチ以内で注文パネルに到達できること**

---

### アプリケーション側が担う責務

1. トレードの整合性を取ること
2. トレードを定義づけること
3. トレードノートを生成すること
4. ノートを素早く見つけられる状態にすること
5. ユーザー指定の時間足ごとに市場を継続監視すること
6. 市場状態と過去ノートを照合すること
7. 類似性が高いと判断された場合、ユーザーに通知すること

---

### 運用ルール（思想ノートの扱い）

- 本ノートは **実装・設計レビュー時の判断基準** とする
- 技術的制約により一時的に満たせない場合でも、
  - 代替案
  - 将来回復可能な設計
  を必ず残す
- 更新は履歴を残した上で追記方式とする

---

※ 本セクションは「思いノート（Living Intent）」として管理し、
プロジェクトの成長に合わせて継続的に更新される。

