# SMA 定義書（Simple Moving Average）

本定義は TradeAssist における SMA（単純移動平均線）の公式ドキュメントであり、雛形と同一構造で記述する。数値と語彙を三層で分離し、マッチング・ノート生成・通知で一貫して利用する。

## メタ情報（管理用）
- indicator_id: `sma`
- カテゴリ: trend（トレンド系）
- 定義バージョン: 1.0.0
- 導入日: 2025-12-27

## 1. インジケーター概要
- 一定期間の終値の算術平均を計算し、トレンド方向と価格の位置付けを視覚化するトレンド系インジケーター
- 標準期間は 20 と 50。本プロジェクトでは終値ベースで算出し、複数期間の組み合わせもユーザー設定で許可する
- SMA は移動平均線の最も基礎的な形式であり、他の MA 系指標（EMA・WMA）の基準となる

## 2. 想定トレーダーペルソナ
- 短期〜中期のトレンド追従を主軸とするトレーダー（経験 2〜5 年、リスク許容度: 中）
- 1 日のうち複数回相場をモニタリングし、SMA が示す方向感と価格位置で判断の粒度を調整する実践的なスタイル
- 逆張りより順張りを基調とし、トレンド発生時の早期エントリーを重視

## 3. 対応トレードスタイル（スキャル / デイ）
- スキャル: 1〜5 分足で短期期間（5・9）を使用。ノイズに敏感で、傾きの反転を即座に捉える。許容ノイズは小。
- デイ: 15〜60 分足で標準期間（20・50）を使用。主要トレンドを確認してからのエントリーを原則とし、日内完結を前提

## 4. 生データとして記録する項目（Layer1）
- 時系列終値（必須）、時間足（例: 1m/5m/15m/60m/1h）、期間 N（標準: 20 と 50）
- 価格取得元: 市場データ API（終値精度は少なくとも小数第 2 位まで保持）
- 欠損補填: 終値欠損時はその足を無視し、連続欠損 2 本以上で算出停止とする
- タイムゾーン: UTC で保存し、表示時にユーザータイムゾーンへ変換
- 複数期間対応: 各期間 N ごとに独立した SMA 値を記録。期間間の関係性（クロスの有無等）は Layer2 で計算

## 5. 判断コンテキスト（Layer2）
- **現在の SMA 値**: 期間 N に対する移動平均値（実数値）
- **傾き（トレンド方向）**: SMA[t] − SMA[t-1]（1 本分の勾配）、および直近 5 本の移動平均傾き
- **傾き方向判定**: 正傾き→「上向きトレンド」、負傾き→「下向きトレンド」、絶対傾き < 0.05 かつ 3 本連続→「横ばい」
- **価格とSMAの乖離**:
  - 絶対乖離: price − SMA（正値: 価格が上、負値: 価格が下）
  - 乖離率: 正規化乖離 = (price − SMA) / SMA × 100（パーセント）
  - 乖離評価: 移動標準偏差相対（直近 N 本での乖離の標準偏差に対する何倍か）→「適度な乖離」「過度に乖離」の判定基準
- **クロスイベント**:
  - SMA クロス: 価格が SMA を上抜け/下抜けした事実、経過本数（クロス後何本経ったか）
  - 複数 SMA クロス: SMA20 < SMA50 の交点（ゴールデンクロス相当）の検出と経過日数
- **ユーザー基準に対する相対的位置**:
  - 許容乖離幅 tol_dev（初期値: 標準偏差の 0.5 倍）内か外か
  - 傾き感度 tol_slope（初期値: 0.1）以上の傾きを「トレンド転換シグナル」として扱うか判定
- **正規化トレンド強度**: trendStrength = (直近 5 本の傾き合計) / (5 × 平均 ATR 相当)→トレンドの強さを 0〜1 で評価

## 6. 言語化レイヤー（Layer3）
- **「上向きトレンド発生」** = 傾き > tol_slope かつ直近 3 本連続正傾き
- **「下向きトレンド発生」** = 傾き < -tol_slope かつ直近 3 本連続負傾き
- **「トレンド継続中」** = 傾き方向が 5 本以上保持され、trendStrength > 0.5
- **「トレンド転換の兆し」** = 傾き反転（正→負または負→正）が 1〜2 本で発生し、前トレンド方向が 5 本以上継続していた場合
- **「押し目・戻り」** = トレンド方向と逆の乖離（上トレンド中に価格が SMA 下まで戻る）で、乖離幅が許容範囲内
- **「過度な乖離」** = 乖離率が ±5%（初期値）を超過。順張りの深掘り買い/売りを検討する段階
- **「乖離の極限化」** = 乖離率が ±10%（初期値）を超過。反発の可能性が高い。逆張り候補圏内
- **「横ばい相場」** = 傾きの絶対値が tol_slope 未満で 3 本以上継続。SMA が判断基準として機能しにくい局面

## 7. ユーザー基準値の扱い
- **標準期間**: 20（短期トレンド）と 50（中期トレンド）を既定値。ユーザーは 5 から 200 の範囲で設定可能
- **乖離許容幅 tol_dev**（初期値: 標準偏差 × 0.5）: 「適度な乖離」と「過度な乖離」の境界。0.3〜1.0 の範囲で変更可能
- **傾き感度 tol_slope**（初期値: 0.1）: トレンド転換を判定する最小傾き。0.01〜0.5 の範囲で変更可能
- **乖離率の警告閾値**（初期値: ±5%）と極限化閾値（初期値: ±10%）: ユーザーが変更可能
- **期間バリデーション**: 整数、5 以上 200 以下。それ以外は拒否
- **設定変更時**: Layer2 の傾き・乖離計算と Layer3 の語彙マッピング両方に即座に反映

## 8. マッチングに使用する特徴量
- 現在 SMA 値、価格との乖離（絶対・比率）、傾き（1 本分と直近 5 本平均）、傾き方向判定フラグ
- 複数期間対応: SMA20 と SMA50 のクロス有無、相互関係（20 が 50 より上/下）
- トレンド強度（trendStrength）、トレンド継続期間、直近の転換イベント有無
- 期間 N と使用時間足。デイトレード基準では 20/50 を 15 分足以上で使用することを期待値とする
- **例マッチング条件**:
  - 「SMA20 が上向きトレンド（傾き > tol_slope）で、価格がSMA上に位置し、乖離が許容範囲内」→ 買いエントリーの根拠
  - 「SMA50 が下向きトレンド継続中で、価格が SMA 下に位置」→ 売り継続の根拠
  - 「SMA20 と SMA50 がゴールデンクロス（20 が 50 を上抜け）し、両者とも上向き傾き」→ 強気シグナル
- **トレンド系としての役割**:
  - SMA は **大局的な値動きの方向を司る柱** として機能
  - RSI などのモメンタム系との組み合わせで「RSI が売られすぎても SMA が上向きなら買い見送り」といった実装が可能に
  - 複数時間足での SMA を参照する際は「大きな足の SMA > 小さな足の SMA」であることを確認してから判断

## 9. AI が利用してよい情報 / 禁止情報
- 利用可: Layer2/Layer3 の特徴量、ユーザーが設定した期間・乖離幅・傾き感度、時間足、マッチ理由のテキスト
- 禁止: 個別の生ローソク足データ（高値・安値など終値以外）、取引数量、個別銘柄名や未公開注文履歴などの個人情報
- AI 入力前に銘柄名・注文ID は匿名化し、数値特徴のみを渡す

## 10. 将来拡張時の注意点
- EMA（指数加重移動平均）や WMA（加重移動平均）への拡張時は、基準値の互換性を検証。SMA の結果と大きく乖離する場合は別バージョンとして管理する
- 複数期間の組み合わせ（SMA20 + SMA50 など）の相互作用は Layer2 レベルで明示化し、AI のマッチング根拠に含める
- 他インジケーター（RSI・BB 等）と組み合わせる際は、SMA が **トレンド軸** として優先順位を持つことを明記。矛盾時の解決ルール（「RSI は売り信号だが SMA は上トレンド→買い見送り」等）を別ドキュメントで定義
- バージョンタグを付与し、期間変更や乖離幅変更がマッチ結果に及ぼす影響を記録。過去ノート再評価が必要な場合はリリースノートに明示

## 11. 本インジケーターが不適切な状況
- **レンジ相場（横ばい局面）**: SMA が機能せず、価格が上下を往復する局面では、乖離ベースの判断だけでは不十分。トレンド系として本来の役割を果たさない
- **経済指標発表前後**: 非連続な価格変動が想定されるため、過去の SMA パターンが通用しない可能性が高い。SMA は遅延指標のため、ジャップの後に大きく乖離する
- **極端な出来高低下時**: スプレッド拡大や流動性不足により、SMA 値が実際のトレンドを反映しない場合がある
- **ユーザー設定の極端な偏り**: 期間が 3 未満や 300 超のような非現実的な値に設定されている場合、トレンド判定が機能しなくなる
- **初期データ不足**: 期間 N 未満のデータしかない場合、計算結果の信頼性が低いため、マッチング判定を保留する
- **市場参加者の急激な入退出**: テーパリング発表やポジション調整局面では、トレンド転換が急激で SMA の遅延に致命的な損失につながる可能性がある
