# BB 定義書（Bollinger Bands）

本定義は TradeAssist における BB（ボリンジャーバンド）の公式ドキュメントであり、雛形と同一構造で記述する。数値と語彙を三層で分離し、マッチング・ノート生成・通知で一貫して利用する。

## メタ情報（管理用）
- indicator_id: `bb`
- カテゴリ: volatility（ボラティリティ系）
- 定義バージョン: 1.0.0
- 導入日: 2025-12-27

## 1. インジケーター概要
- 移動平均線を中心に、標準偏差に基づいた上下のバンドを描画し、価格のボラティリティと相場の過熱・冷却状態を示すボラティリティ系インジケーター
- 標準期間は 20、標準偏差倍数は 2。本プロジェクトでは終値ベースで SMA および標準偏差を算出し、期間・倍数の変更はユーザー設定として許可する
- 単体での売買判断は行わず、トレンド系（SMA）や過熱系（RSI）の補助指標として機能させる

## 2. 想定トレーダーペルソナ
- 短期〜中期のトレンド追従とボラティリティ管理を両立させるトレーダー（経験 2〜4 年、リスク許容度: 中）
- 日中は定期的に相場をモニタリングし、バンド幅の拡大・縮小と価格位置を組み合わせて判断を微調整する実践的なスタイル
- トレンド判定を SMA で行い、BB でタイミング精度を高める二段構えの運用方針

## 3. 対応トレードスタイル（スキャル / デイ）
- スキャル: 1〜5 分足で短期期間（10・15）を使用。バンド幅の急速な拡大・縮小に敏感に反応。ノイズ許容は小。
- デイ: 15〜60 分足で標準期間（20）を使用。主要トレンド（SMA）と調和し、過度な乖離（バンド張り付き）を確認してからのトレード実行を原則とする

## 4. 生データとして記録する項目（Layer1）
- 時系列終値（必須）、時間足（例: 1m/5m/15m/60m/1h）、期間 N（標準: 20）、標準偏差倍数 σ_mult（標準: 2）
- 価格取得元: 市場データ API（終値精度は少なくとも小数第 2 位まで保持）
- 欠損補填: 終値欠損時はその足を無視し、連続欠損 2 本以上で算出停止とする
- タイムゾーン: UTC で保存し、表示時にユーザータイムゾーンへ変換
- 複数期間対応: 期間 N ごとに独立した SMA（ミドルバンド）、標準偏差、上下バンド値を記録

## 5. 判断コンテキスト（Layer2）
- **ミドルバンド（SMA）**: 期間 N の単純移動平均値（実数値）
- **標準偏差（σ）**: 期間 N での終値の標準偏差（実数値）
- **上バンド**: ミドルバンド + σ × σ_mult
- **下バンド**: ミドルバンド − σ × σ_mult
- **バンド幅（Bollinger Bands Width）**:
  - 絶対幅: (上バンド − 下バンド)（実数値）
  - 正規化幅: (上バンド − 下バンド) / ミドルバンド × 100（パーセント）→時間足や期間を超えた比較を可能にする
  - バンド幅傾き: 幅[t] − 幅[t-1]（拡大→正値、縮小→負値）
- **価格のバンド内位置（%B; Percent B）**:
  - %B = (価格 − 下バンド) / (上バンド − 下バンド) × 100
  - 0 = 下バンドにピッタリ、50 = ミドルバンド、100 = 上バンドにピッタリ
  - 100 超 = 上バンド外（張り付き）、0 未満 = 下バンド外
  - %B は期間や環境に依存しない相対位置を 0〜100 で統一表現するため、Layer3 判定の基本となる
- **バンドからの絶対距離**:
  - distUpper = 上バンド − 価格（正値: 価格が下バンド側）
  - distLower = 価格 − 下バンド（正値: 価格が上バンド側）
  - 距離が小さい（接近）→ バンドへの張り付き傾向、距離が大きい → 中央に寄っている状態
- **接近判定**:
  - 上バンド接近: distUpper が 0 以上かつ、%B > (100 − tol_near)（初期値: tol_near = 10）
  - 下バンド接近: distLower が 0 以上かつ、%B < tol_near
- **バンド幅の拡張 / 縮小状態**:
  - バンド幅傾き > 0 が 2 本以上継続 → 「拡張局面」
  - バンド幅傾き < 0 が 2 本以上継続 → 「収縮局面」
  - 正規化バンド幅の履歴（直近 10 本）を保持。最小値・最大値・現在の相対位置を計算
- **バンドと SMA（ミドルバンド）の関係**:
  - SMA 傾き方向（上向き/下向き）と、ミドルバンド傾き（同一）の確認
  - 価格が上バンド近接 + SMA 上向き = 「トレンド継続示唆」
  - 価格が下バンド近接 + SMA 下向き = 「下トレンド継続示唆」
  - 価格が上バンド張り付き + SMA 横ばい = 「買われすぎの可能性」
- **直近 RSI との比較（整合性確認用）**:
  - RSI が売られすぎ（< lower_rsi）で、かつ価格が下バンド近接 → 整合（逆張り買い候補）
  - RSI が買われすぎ（> upper_rsi）で、かつ価格が上バンド張り付き → 整合（逆張り売り候補）
  - RSI が買われすぎだが価格が下バンド側 → **矛盾フラグ**（注意喚起対象）

## 6. 言語化レイヤー（Layer3）
- **「バンド拡張中」** = バンド幅傾き > 0 が 2 本以上継続し、正規化バンド幅が過去 10 本平均より大きい
  - 含意: ボラティリティが上昇している局面。トレンド発生初期の可能性あり
- **「バンド収縮中」** = バンド幅傾き < 0 が 2 本以上継続し、正規化バンド幅が過去 10 本平均より小さい
  - 含意: ボラティリティが低下している局面。反発・反転が近い可能性あり
- **「上バンド張り付き」** = %B が (100 − tol_near) 以上、かつこの状態が 2 本以上継続
  - 含意: 価格が上昇トレンドで走っている状態。買われすぎの可能性だが、SMA が上向きなら継続示唆
  - 警告: **RSI が売られすぎ（< 30）かつ上バンド張り付き → 矛盾あり。見送り推奨**
- **「下バンド張り付き」** = %B が tol_near 未満、かつこの状態が 2 本以上継続
  - 含意: 価格が下降トレンドで走っている状態。売られすぎの可能性だが、SMA が下向きなら継続示唆
  - 警告: **RSI が買われすぎ（> 70）かつ下バンド張り付き → 矛盾あり。見送り推奨**
- **「上バンドウォーク」** = 価格が上バンド付近（%B > 80）で複数本移動し、同期間中 SMA が上向き傾き
  - 含意: 強気トレンド継続。売りタイミングではなく、押し目買い候補
- **「下バンドウォーク」** = 価格が下バンド付近（%B < 20）で複数本移動し、同期間中 SMA が下向き傾き
  - 含意: 弱気トレンド継続。買いタイミングではなく、戻り売り候補
- **「バンドタッチ（上）」** = 価格が上バンドに接触（%B ≥ 100）したが、次足で %B が低下に転じた
  - 含意: 上値の硬さ / 売り圧力の兆し。反発・反転の可能性。逆張り売り候補（ただし SMA 確認必須）
- **「バンドタッチ（下）」** = 価格が下バンドに接触（%B ≤ 0）したが、次足で %B が上昇に転じた
  - 含意: 下値の堅さ / 買い圧力の兆し。反発・反転の可能性。逆張り買い候補（ただし SMA 確認必須）
- **「バンド中立」** = %B が (tol_near) 以上かつ (100 − tol_near) 以下が 3 本以上継続
  - 含意: レンジ相場。BB が売買判断の基準として機能しにくい局面

## 7. ユーザー基準値の扱い
- **標準期間**: 20（標準）。5 から 100 の範囲で設定可能。短期（10・15）でスキャル対応、長期（25・30）でデイ対応
- **標準偏差倍数 σ_mult**: 2.0（標準）。1.5 から 3.0 の範囲で設定可能
  - 1.5: より狭いバンド、シグナル頻度が高くなるがノイズに敏感
  - 2.0: 標準的なバランス
  - 2.5 以上: より広いバンド、シグナル頻度は下がるがより確度の高いシグナルに限定される
- **接近許容幅 tol_near**: 初期値 10（%B スケールで ±10）。0 から 30 の範囲で設定可能
  - 小さい値（0〜5）: 厳密なバンド張り付き判定だが、シグナルは少ない
  - 大きい値（15〜30）: 接近判定がより緩く、シグナル頻度が増加
- **バリデーション**:
  - 期間 N: 整数、5 以上 100 以下。それ以外は拒否
  - σ_mult: 実数、1.0 以上 4.0 以下。それ以外は拒否
  - tol_near: 実数、0 以上 50 以下
- **設定変更時**: Layer2 の全値（バンド幅・%B・距離・接近判定）と Layer3 の語彙マッピング両方に即座に反映

## 8. マッチングに使用する特徴量
- **基本値**: 現在の %B、上下バンド値、バンド幅（絶対・正規化）、バンド幅傾き
- **状態判定**: 拡張局面フラグ、収縮局面フラグ、張り付き判定（上/下）、バンドウォークフラグ
- **クロスイベント**: バンドタッチ（上/下）の発生タイミング、経過本数
- **期間 N と使用時間足**: スタイル別に期待される期間と時間足の整合をチェック
- **SMA との整合**: ミドルバンドの傾き方向、価格の乖離方向との一貫性
- **RSI との矛盾検出**:
  - 例A: 「%B > 90（上バンド張り付き）かつ RSI < 30（売られすぎ）」→ **矛盾フラグ**。「RSI と BB が相反する信号。売り見送り推奨」と注意喚起を生成
  - 例B: 「%B < 10（下バンド張り付き）かつ RSI > 70（買われすぎ）」→ **矛盾フラグ**。「RSI と BB が相反する信号。買い見送り推奨」と注意喚起を生成
- **マッチング条件例**:
  - 「バンド幅が過去 10 本で最小値に接近（収縮極限）し、SMA が方向を示している」→ ボラティリティ拡張の初期段階で、トレンド発生の可能性あり。トレンド追従エントリー候補
  - 「上バンドウォークが 3 本以上継続し、SMA が上向き」→ 買いトレンド継続。押し目買いのタイミング探索フェーズ
  - 「下バンドタッチで %B が 0 未満に達し、次足で %B が上昇に転じた」→ 逆張り買いのシグナル（SMA 下向き確認前提）
- **役割**: ボラティリティ系 / 価格位置系（過熱判定補助）。単独での確定判断は行わず、トレンド系（SMA）と過熱系（RSI）との整合を必須とする

## 9. AI が利用してよい情報 / 禁止情報
- 利用可: Layer2/Layer3 の特徴量（%B・バンド幅・拡張縮小フラグ等）、ユーザーが設定した期間・σ_mult・接近許容幅、時間足、マッチ理由のテキスト、SMA / RSI との整合判定結果
- 禁止: 個別の生ローソク足データ（高値・安値など終値以外）、取引数量、個別銘柄名や未公開注文履歴などの個人情報
- AI 入力前に銘柄名・注文ID は匿名化し、数値特徴のみを渡す
- **矛盾フラグ（RSI vs BB）が立った場合**: AI は注意喚起テキストを自動生成し、エントリー見送りを推奨するメッセージを含める

## 10. 将来拡張時の注意点
- 標準偏差計算を Wilder 平滑化や EMA 平滑化へ変更する場合は基準値の互換性を検証し、過去ノートとの齟齬を明示する
- 複数倍数（±1σ・±2σ・±3σ）の同時使用拡張時は、各倍数ごとに独立した判定ルールを定義。混同を避けるため、マッチング条件で倍数を明示する
- 他インジケーター（RSI・SMA）との組み合わせ時は、以下の優先順位を厳守:
  - **1位（トレンド軸）**: SMA の傾き方向 → BB は補助指標として機能させる
  - **2位（過熱判定）**: RSI の上限/下限 → BB は整合確認に使う
  - **3位（ボラティリティ補助）**: BB の拡張・収縮 → トレンド発生の兆しを補足
- バージョンタグを付与し、期間・σ_mult 変更がマッチ結果に及ぼす影響を記録。過去ノート再評価が必要な場合はリリースノートに明示
- 矛盾検出ロジック（RSI vs BB）の精度調整が必要になった場合は、検出ルール自体のバージョンアップを別途管理する

## 11. 本インジケーターが不適切な状況
- **強トレンド継続局面**: SMA が明確に上昇/下降を継続している場合、BB のバンド幅が拡張し続ける。この局面での BB 単独の反転シグナルは機能しにくく、矛盾を検出して注意喚起すること
- **経済指標発表前後**: 非連続な価格変動が想定されるため、標準偏差計算が実際のボラティリティを反映しない可能性が高い。BB は意味をなさなくなる
- **極端な出来高低下時**: スプレッド拡大や流動性不足により、バンド幅とローソク足の関係が不規則になる。判定精度が大幅に低下
- **ユーザー設定の極端な偏り**: σ_mult が 0.5 未満や 5 超のような非現実的な値、tol_near が 50 超のような値に設定されている場合、判定が破綻する
- **初期データ不足**: 期間 N 未満のデータしかない場合、標準偏差計算の信頼性が低いため、マッチング判定を保留する
- **市場参加者の急激な入退出**: テーパリング発表やポジション調整局面では、標準偏差が過去の参考にならなくなり、バンド設定が陳腐化する。リアルタイム調整が必要な可能性あり
- **RSI が極端な値かつ BB が矛盾シグナル**: 両指標が相反する場合は、**エントリー見送りを優先** として注意喚起を強化すること
