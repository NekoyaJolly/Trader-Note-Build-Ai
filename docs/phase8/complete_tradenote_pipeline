了解。
ここまでのプロジェクトの状況、あなたの慎重さ、そして本番デプロイでのエラー経験まで含めて理解した上で、**「CSV 取得・日次バッチ・推定 AI まで含めた完全版の Agent 用プロンプト」**を一発で実行できる形で作成します。
品質保証についても明確なルールとして入れています。

以下のプロンプトは、そのまま Agent に渡せば **トレードノート生成パイプラインを一気通貫で構築・検証・品質保証**まで行える形です。

---

# 📌 完全版 Agent 実行プロンプト

## 「トレードノート生成 & CSV 取得 / 日次バッチ / 推定 AI 設計 実装」

品質保証付き

```
あなたは TradeAssist プロジェクトの Complete TradeNote Pipeline 実装担当 Agent です。

目的：
以下の機能をまとめて構築し、
**品質保証されたトレードノート生成フローを一気通貫で完成させる**こと。

対象：
- CSV 取得エージェント
- 日次バッチ自動化（Railway Cron）
- 推定 AI Prompt 設計
- ノート生成パイプライン（事後復元）
- 自動テスト・品質チェック設計

前提：
- 本番インフラは Vercel + Railway
- Phase6 仕様フリーズ完了
- Phase7 / Phase8 は本番デプロイ済み

---

## 実装ステップ（全体）

### Step 1：CSV 取得エージェントの実装

目的：
ユーザーがエクスポートした取引履歴 CSV を  
自動で取り込み・パースし、本番品質で DB に保存する。

要件：

1. **フォルダ監視 / タイミング監視の仕組み**
   - Railway に置く場合はファイル受け取り API
   - ローカル同期は CLI でも OK

2. CSV パーサー品質
   - 拡張子のチェック
   - 列名のバリデーション
   - 異常行はスキップ・ログ記録
   - 正常行はすべて DB 保存

3. エラーハンドリング
   - シンタックスエラーは詳細ログ
   - DB コネクトエラーは即通知（Railway Logs）
   - 異常パターンは通知バナーで安全に報告

品質保証：

- CSV 正常系/異常系テスト実装
- CSV パースの境界テスト
- Logging・通知の動作テスト

成果物：

- CLI: `import-trades.ts`
- API: `/api/trades/import`
- Test: `tradeImportService.test.ts`

---

### Step 2：日次バッチ自動化（Railway Cron）

目的：
毎日決まった時間にトレード履歴の取得とノート生成バッチを実行し、
必ず完了ログまたはエラーログを出力する。

要件：

1. Railway Cron 設定
   - 定期実行タスク
   - 前回実行時刻以降の CSV/取引データ取得

2. バッチ処理内容
   - CSV 取得（Step 1 の仕組み）
   - DB と市場データの整合
   - インジケーター計算（SMA/RSI/BB/MACD）
   - 推定 AI 呼び出し + ノート下書き生成

3. 失敗時の挙動
   - 軽度エラー → リトライフラグ + 次回まとめて実行
   - 致命エラー → Notification（Push + In-App）

品質保証：

- バッチ成功/部分失敗/致命失敗のテスト
- Cron の単体・統合テスト
- Railway Cron 設定が正しく反映されるかの確認

成果物：

- Cron スケジュール設定
- 日次実行バッチコード
- バッチログトラッキング

---

### Step 3：推定 AI Prompt 設計（判断モード・時間足）

目的：
AI による「判断モード推定（順張り/逆張り）」と  
「主/補助時間足推定」を行わせるための **最適プロンプトセット**を設計する。

要件：

1. 推定対象
   - 指定時間足（最大3つ）
   - インジケーター値（Layer1/Layer2/Layer3）

2. 推定出力
   - primaryTimeframe
   - secondaryTimeframes（0〜2）
   - inferredMode（trend / meanReversion / other）
   - rationale（推定理由）

3. 推定精度補強
   - 正規化された特徴量を与える
   - ユーザー基準値を明示する
   - AIが曖昧な場合は「不明」と出力

品質保証：

- AI 推定テスト
- 推定と実際の一致検証テスト
- 推定異常ケース（conflict/insufficient data）テスト

成果物：

- Prompt 定義ファイル
- 自動テストケース
- 推定サンプルログ

---

### Step 4：トレードノート生成パイプライン完成

目的：
Step1〜3 を統合し、
**事後復元型トレードノートの自動生成バッチ**を完成させる。

処理：

1. トレード履歴 DB 取得
2. 市場データ取得・インジケーター計算
3. 推定 AI で判断モード + 時間足決定
4. ノート下書き生成
5. DB に Draft ノート保存

品質保証：

- Draft 生成の統合テスト
- FeatureVector の正規化テスト
- UI と統合してノート表示確認

成果物：

- ノート生成エンジン
- 統合テストスイート
- UI 結合確認ログ

---

## 品質保証基準（全体）

全実装は以下を必須とする：

1. ESLint / Prettier のチェック
2. 型安全（TypeScript Strict）
3. 単体テスト + 結合テスト
4. 本番環境変数に対応
5. 明確なエラーハンドリング
6. Logging が実稼働レベル

---

## CI / CD テスト

- GitHub Actions で
  - lint
  - typecheck
  - test
をパスしないと main へマージ禁止

---

## 禁止事項

- リアルタイム監視機能（まだ不要）
- 実稼働 DBの破壊的操作
- 本番環境で migrate reset
- 不完全な AI 推定

---

## 成果物報告フォーマット（必須）

以下形式で必ず報告すること：

```

【CSV 取得エージェント】

* CLI/API 実装
* 正常系/異常系テスト

【日次バッチ自動化】

* Cron 設定
* 統合テストログ

【推定 AI Prompt 設計】

* Prompt リスト
* 推定結果サンプル

【ノート生成エンジン】

* 入力/出力仕様
* 結合テストログ

【品質保証】

* ESLint/Prettier
* 型チェック
* CI/CD 成功

```

---

## 最重要原則（再掲）

> 本番運用に値するコードとパイプライン以外は出力しない。  
> 品質保証が担保されなければ「完了報告」を出さない。

---

以上の指示に従い、**完全版トレードノート生成パイプライン**を構築してください。
```
