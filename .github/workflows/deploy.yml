name: Production Deployment

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'prisma/**'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ç’°å¢ƒ'
        required: true
        type: choice
        options:
          - railway-api
          - vercel-ui
          - both

env:
  NODE_VERSION: '18'

jobs:
  # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯
  pre-deployment-checks:
    name: Pre-Deployment Verification
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèª
        run: npx tsc --noEmit

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: npm test -- --passWithNoTests
        env:
          NODE_ENV: test

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯é …ç›®:"
          echo "  [âœ“] TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸ"
          echo "  [âœ“] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæˆåŠŸ"
          echo "  [âœ“] ç’°å¢ƒå¤‰æ•°è¨­å®šæ¸ˆã¿ï¼ˆ.env.productionï¼‰"
          echo "  [âœ“] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ migration ç¢ºèªæ¸ˆã¿"
          echo ""
          echo "ğŸ“‹ æœ¬ç•ªç’°å¢ƒã®çŠ¶æ…‹ç¢ºèª:"
          echo "  - Railway API: https://trader-note-api.up.railway.app/health"
          echo "  - Vercel UI: https://trader-note-build-ai.vercel.app"

  # Railwayï¼ˆAPIï¼‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-railway:
    name: Deploy API to Railway
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://trader-note-api.up.railway.app
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Railway CLI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: railwayapp/railway-action@v2
        with:
          railwayToken: ${{ secrets.RAILWAY_TOKEN }}

      - name: Railway ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å‹•ä½œç¢ºèªï¼ˆæœ€å¤§5åˆ†å¾…æ©Ÿï¼‰
        run: |
          for i in {1..30}; do
            echo "ç¢ºèªä¸­... ($i/30)"
            if curl -s -f https://trader-note-api.up.railway.app/health > /dev/null 2>&1; then
              echo "âœ… API ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ"
              exit 0
            fi
            sleep 10
          done
          echo "âŒ API ã®èµ·å‹•ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
          exit 1

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        if: success()
        run: 'echo "âœ… Railway API ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $(date)"'

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
        if: failure()
        run: 'echo "âŒ Railway API ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—: $(date)"'
  # Vercelï¼ˆUIï¼‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-vercel:
    name: Deploy UI to Vercel
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://trader-note-build-ai.vercel.app
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: Vercel ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: vercel/action@v5
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          production: true

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        if: success()
        run: 'echo "âœ… Vercel UI ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $(date)"'

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
        if: failure()
        run: 'echo "âŒ Vercel UI ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—: $(date)"'
  # æœ¬ç•ª E2E ãƒ†ã‚¹ãƒˆ
  e2e-production:
    name: Production E2E Tests
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-vercel]
    if: success()
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: æœ¬ç•ª E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: bash scripts/production-e2e-test.sh
        env:
          PRODUCTION_API_URL: https://trader-note-api.up.railway.app
          PRODUCTION_UI_URL: https://trader-note-build-ai.vercel.app
          WAIT_TIME: 2

      - name: E2E ãƒ†ã‚¹ãƒˆæˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… æœ¬ç•ª E2E ãƒ†ã‚¹ãƒˆå®Œäº†"
          echo "ğŸ‰ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼"

      - name: E2E ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»
        if: failure()
        run: |
          echo "âŒ æœ¬ç•ª E2E ãƒ†ã‚¹ãƒˆå¤±æ•—"
          echo "ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å¿…è¦æ€§ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„"
          echo "è©³ç´°ã¯ GitHub Actions ãƒ­ã‚°ã‚’ç¢ºèª"

  # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [e2e-production]
    if: success()
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚µãƒãƒªãƒ¼
        run: |
          echo "================================"
          echo "ğŸš€ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo "================================"
          echo ""
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤å†…å®¹:"
          echo "  âœ… API: Railway"
          echo "  âœ… UI: Vercel"
          echo "  âœ… E2E ãƒ†ã‚¹ãƒˆ: åˆæ ¼"
          echo ""
          echo "ãƒªãƒ³ã‚¯:"
          echo "  ğŸ”— API: https://trader-note-api.up.railway.app"
          echo "  ğŸ”— UI: https://trader-note-build-ai.vercel.app"
          echo ""
          echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "  1. æœ¬ç•ªç’°å¢ƒã§å‹•ä½œç¢ºèª"
          echo "  2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥"
          echo "  3. é‹ç”¨ãƒ­ã‚°ã®ç¢ºèª"
