name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io

jobs:
  # TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ« & lint ãƒã‚§ãƒƒã‚¯
  lint-and-build:
    name: TypeScript Lint & Build
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ã®ã¿ï¼‰
        run: npx tsc --noEmit

      - name: ESLint ãƒã‚§ãƒƒã‚¯ï¼ˆè¨­å®šãŒã‚ã‚‹å ´åˆï¼‰
        run: npm run lint --if-present || echo "ESLint ã‚¹ã‚­ãƒƒãƒ—"

  # ãƒ¦ãƒ‹ãƒƒãƒˆï¼†çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    services:
      # PostgreSQL ãƒ†ã‚¹ãƒˆç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: Prisma ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: Jest ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: npm test -- --coverage --passWithNoTests
        env:
          # ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
          NODE_ENV: test
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          fail_ci_if_error: false

  # ãƒ­ãƒ¼ã‚«ãƒ« E2E ãƒ†ã‚¹ãƒˆï¼ˆé–‹ç™ºç’°å¢ƒã§ã®å‹•ä½œç¢ºèªï¼‰
  e2e-local:
    name: Local E2E Tests
    runs-on: ubuntu-latest
    services:
      # PostgreSQL ãƒ†ã‚¹ãƒˆç”¨
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: Prisma ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
        run: npm run dev > /tmp/dev-server.log 2>&1 &
        env:
          NODE_ENV: development
          PORT: 3100
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…æ©Ÿï¼ˆæœ€å¤§30ç§’ï¼‰
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3100/health > /dev/null 2>&1; then
              echo "ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ç¢ºèª: OK"
              exit 0
            fi
            echo "å¾…æ©Ÿä¸­... ($i/30)"
            sleep 1
          done
          echo "ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"
          cat /tmp/dev-server.log
          exit 1

      - name: ãƒ­ãƒ¼ã‚«ãƒ« E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: bash scripts/local-e2e-test.sh
        env:
          API_URL: http://localhost:3100
          WAIT_TIME: 1

  # ãƒ“ãƒ«ãƒ‰æˆåŠŸç¢ºèª
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint-and-build, test]
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
        run: npm run build --if-present || echo "Build script not found"

  # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥ï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  notify-deployment:
    name: Notify Deployment Readiness
    runs-on: ubuntu-latest
    needs: [lint-and-build, test, e2e-local, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†ãƒ­ã‚°
        run: |
          echo "âœ… CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†"
          echo "ğŸ“¦ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†"
          echo "ğŸš€ Railway & Vercel ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã§ã™"
          echo ""
          echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "1. Railway API ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ—ãƒƒã‚·ãƒ¥"
          echo "2. Vercel ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤"
          echo "3. æœ¬ç•ª E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
